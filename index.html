<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TheONE สอบราชการ</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material Symbols (Icons) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "admin-primary": "#7c3aed",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "Noto Sans Thai", "sans-serif"],
                        "body": ["Public Sans", "Noto Sans Thai", "sans-serif"],
                    },
                },
            },
        }
    </script>

    <!-- React & ReactDOM & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Public Sans', 'Noto Sans Thai', sans-serif; background-color: #f3f4f6; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #app-container {
            max-width: 100%;
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        
        @media (min-width: 768px) {
            #app-container { max-width: 768px; }
        }
        
        @media (min-width: 1024px) {
            body { padding: 0; display: flex; justify-content: center; }
            #app-container { max-width: 600px; min-height: 100vh; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; }
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #137fec;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased">
    <div id="root" class="w-full"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDF6XI3Rs4CAdA83QQQ2aQ1J-prKT7mqlg",
            authDomain: "application-01-986a7.firebaseapp.com",
            databaseURL: "https://application-01-986a7-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "application-01-986a7",
            storageBucket: "application-01-986a7.firebasestorage.app",
            messagingSenderId: "206440554854",
            appId: "1:206440554854:web:2d804d1e35c824fadca8a7",
            measurementId: "G-9NDBRSERT7"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            firebase.firestore().enablePersistence().catch(err => {
                console.log('Persistence disabled or error:', err.code);
            });
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Utility ---
        const normalizeAnswer = (ans) => {
            if (!ans) return '';
            const str = String(ans).trim().toUpperCase();
            const map = { '1': 'A', 'ก': 'A', 'A': 'A', '2': 'B', 'ข': 'B', 'B': 'B', '3': 'C', 'ค': 'C', 'C': 'C', '4': 'D', 'ง': 'D', 'D': 'D' };
            return map[str] || str;
        };

        const getYoutubeId = (url) => {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        const getYoutubeThumbnail = (url) => {
            const id = getYoutubeId(url);
            return id ? `https://img.youtube.com/vi/${id}/mqdefault.jpg` : null;
        };

        const INITIAL_MOCK_EXAM = {
            title: "แนวข้อสอบ ก.พ. ภาค ก. (ตัวอย่าง)",
            subject: "วิชากฎหมายและระเบียบข้าราชการ",
            timeLimit: 30 * 60,
            questions: [
                 { id: 1, question: "ข้อใดต่อไปนี้ ไม่ใช่ หลักธรรมาภิบาล?", options: [{ id: 'A', text: "ก. หลักนิติธรรม" }, { id: 'B', text: "ข. หลักคุณธรรม" }, { id: 'C', text: "ค. หลักความลับ" }, { id: 'D', text: "ง. หลักความโปร่งใส" }], correct: 'C', explanation: "หลักความลับไม่ใช่หลักธรรมาภิบาล ตามระเบียบสำนักนายกรัฐมนตรีว่าด้วยการสร้างระบบบริหารกิจการบ้านเมืองและสังคมที่ดี พ.ศ. 2542" }
            ]
        };

        function Icon({ name, className = "", style = {} }) {
            return <span className={`material-symbols-outlined ${className}`} style={style}>{name}</span>;
        }

        function LoadingSpinner() {
            return (
                <div className="flex justify-center items-center h-full w-full py-10">
                    <div className="spinner"></div>
                </div>
            );
        }

        // --- Main App ---
        function App() {
            const [currentScreen, setCurrentScreen] = useState('loading'); 
            const [user, setUser] = useState(null);
            
            // --- Shared Data State (Centralized for Speed) ---
            const [exams, setExams] = useState([]);
            const [videos, setVideos] = useState([]);
            const [summaries, setSummaries] = useState([]);
            const [dataLoaded, setDataLoaded] = useState(false);

            const [selectedExam, setSelectedExam] = useState(null);
            const [examState, setExamState] = useState({
                answers: {},
                currentQuestionIndex: 0,
                isFinished: false,
                score: 0,
                timeRemaining: 0,
                feedbackMode: false 
            });

            // 1. Auth & Data Loading (Combined for efficiency)
            useEffect(() => {
                const unsubscribeAuth = auth.onAuthStateChanged(async (authUser) => {
                    if (authUser) {
                        try {
                            const userDoc = await db.collection('users').doc(authUser.uid).get();
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                setUser({ uid: authUser.uid, email: authUser.email, ...userData });
                                if (userData.status === 'pending') setCurrentScreen('pending-approval');
                                else if (userData.role === 'admin') setCurrentScreen('admin-home');
                                else setCurrentScreen('home');
                            } else {
                                await auth.signOut();
                                setCurrentScreen('login');
                            }
                        } catch (error) {
                            setCurrentScreen('login');
                        }
                    } else {
                        setUser(null);
                        setCurrentScreen('login');
                    }
                });

                // Listen to Global Data ONCE
                const unsubExams = db.collection('exams').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setExams(data.length ? data : [INITIAL_MOCK_EXAM]);
                });

                const unsubVideos = db.collection('videos').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    setVideos(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const unsubSummaries = db.collection('summaries').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    setSummaries(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setDataLoaded(true);
                });

                return () => {
                    unsubscribeAuth();
                    unsubExams();
                    unsubVideos();
                    unsubSummaries();
                };
            }, []);

            const navigate = (screen) => {
                window.scrollTo(0, 0);
                setCurrentScreen(screen);
            };

            const handleLogout = async () => {
                await auth.signOut();
                navigate('login');
            };

            const startExam = (examData) => {
                setSelectedExam(examData);
                setExamState({
                    answers: {},
                    currentQuestionIndex: 0,
                    isFinished: false,
                    score: 0,
                    timeRemaining: examData.timeLimit || 30 * 60,
                    feedbackMode: false
                });
                navigate('exam');
            };

            const handleAnswer = (questionId, optionId) => {
                if (examState.answers[questionId]) return;
                setExamState(prev => ({
                    ...prev,
                    answers: { ...prev.answers, [questionId]: optionId },
                    feedbackMode: true 
                }));
            };

            const handleNextQuestion = () => {
                if (examState.currentQuestionIndex < selectedExam.questions.length - 1) {
                    setExamState(prev => ({
                        ...prev,
                        currentQuestionIndex: prev.currentQuestionIndex + 1,
                        feedbackMode: false 
                    }));
                } else {
                    submitExam();
                }
            };

            const submitExam = () => {
                if (!selectedExam) return;
                let correctCount = 0;
                selectedExam.questions.forEach(q => {
                    if (normalizeAnswer(examState.answers[q.id]) === normalizeAnswer(q.correct)) correctCount++;
                });
                const scorePercentage = Math.round((correctCount / selectedExam.questions.length) * 100);
                setExamState(prev => ({ ...prev, isFinished: true, score: scorePercentage }));
                navigate('result');
                if (user) {
                    db.collection('exam_results').add({
                        userId: user.uid,
                        examTitle: selectedExam.title,
                        score: scorePercentage,
                        date: new Date(),
                        status: scorePercentage >= 60 ? 'pass' : 'fail'
                    }).catch(e => console.error(e));
                }
            };

            useEffect(() => {
                let interval;
                if (currentScreen === 'exam' && !examState.isFinished && examState.timeRemaining > 0) {
                    interval = setInterval(() => {
                        setExamState(prev => {
                            if (prev.timeRemaining <= 1) {
                                clearInterval(interval);
                                return { ...prev, timeRemaining: 0, isTimeUp: true }; 
                            }
                            return { ...prev, timeRemaining: prev.timeRemaining - 1 };
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [currentScreen, examState.isFinished]);

            useEffect(() => {
                if (examState.isTimeUp && !examState.isFinished) submitExam();
            }, [examState.isTimeUp]);

            if (currentScreen === 'loading' && !dataLoaded) return <div className="min-h-screen flex items-center justify-center bg-white"><div className="spinner"></div></div>;

            return (
                <div id="app-container">
                    {currentScreen === 'login' && <LoginScreen onNavigate={navigate} />}
                    {currentScreen === 'register' && <RegisterScreen onNavigate={navigate} />}
                    {currentScreen === 'pending-approval' && <PendingApprovalScreen onLogout={handleLogout} />}
                    
                    {currentScreen === 'home' && <HomeScreen user={user} exams={exams} onNavigate={navigate} onStartExam={startExam} />}
                    {currentScreen === 'category' && <CategoryScreen exams={exams} onNavigate={navigate} onStartExam={startExam} />}
                    {currentScreen === 'summary' && <SummaryScreen user={user} summaries={summaries} onNavigate={navigate} />}
                    {currentScreen === 'video' && <VideoScreen user={user} videos={videos} onNavigate={navigate} />}
                    {currentScreen === 'history' && <HistoryScreen user={user} onNavigate={navigate} />}
                    {currentScreen === 'profile' && <ProfileScreen user={user} onNavigate={navigate} onLogout={handleLogout} />}
                    
                    {currentScreen === 'exam' && selectedExam && (
                        <ExamScreen 
                            examData={selectedExam} 
                            examState={examState} 
                            onAnswer={handleAnswer} 
                            onNext={handleNextQuestion}
                            onSubmit={submitExam}
                            onNavigate={navigate}
                        />
                    )}
                    
                    {currentScreen === 'result' && selectedExam && (
                        <ResultScreen 
                            examState={examState} 
                            totalQuestions={selectedExam.questions.length}
                            onNavigate={navigate}
                        />
                    )}
                    
                    {currentScreen === 'admin-home' && user?.role === 'admin' && <AdminHomeScreen user={user} stats={{users:0, exams: exams.length}} onNavigate={navigate} onLogout={handleLogout} />}
                    {currentScreen === 'admin-exams' && user?.role === 'admin' && <AdminExamScreen exams={exams} videos={videos} summaries={summaries} onNavigate={navigate} />}
                    {currentScreen === 'admin-users' && user?.role === 'admin' && <AdminUserScreen onNavigate={navigate} currentUser={user} />}
                </div>
            );
        }

        // --- Screen Components ---

        function LoginScreen({ onNavigate }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    setError('อีเมลหรือรหัสผ่านไม่ถูกต้อง');
                    setLoading(false);
                }
            };
            
            return (
                <div className="flex flex-col items-center justify-center min-h-screen px-6 relative overflow-hidden bg-white">
                    <div className="absolute top-[-10%] right-[-5%] w-72 h-72 bg-primary/10 rounded-full blur-3xl"></div>
                    <div className="absolute bottom-[-10%] left-[-5%] w-72 h-72 bg-blue-400/10 rounded-full blur-3xl"></div>
                    <div className="w-full max-sm z-10">
                        <div className="flex flex-col items-center mb-10">
                            <div className="w-24 h-24 rounded-full overflow-hidden shadow-xl shadow-blue-500/20 mb-6 border-4 border-white transform hover:scale-105 transition-transform duration-300">
                                <img src="https://img2.pic.in.th/channels4_profileb88383d3623b24ab.jpg" alt="Logo" className="w-full h-full object-cover" />
                            </div>
                            <h1 className="text-2xl font-bold text-[#111418]">เข้าสู่ระบบ</h1>
                            <p className="text-slate-500 text-sm mt-2">เตรียมตัวสอบข้าราชการไปกับเรา</p>
                        </div>
                        <form className="flex flex-col gap-5" onSubmit={handleLogin}>
                            {error && <div className="bg-red-50 text-red-500 text-sm p-3 rounded-xl text-center">{error}</div>}
                            <div className="space-y-1.5">
                                <label className="text-sm font-medium text-slate-700 ml-1">อีเมล</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                                        <Icon name="mail" className="text-slate-400 group-focus-within:text-primary transition-colors" />
                                    </div>
                                    <input type="email" required className="block w-full rounded-2xl border-0 py-3.5 pl-12 text-[#111418] shadow-sm ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary bg-white" placeholder="user@example.com" value={email} onChange={(e) => setEmail(e.target.value)} />
                                </div>
                            </div>
                            <div className="space-y-1.5">
                                <label className="text-sm font-medium text-slate-700 ml-1">รหัสผ่าน</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                                        <Icon name="lock" className="text-slate-400 group-focus-within:text-primary transition-colors" />
                                    </div>
                                    <input type="password" required className="block w-full rounded-2xl border-0 py-3.5 pl-12 pr-12 text-[#111418] shadow-sm ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary bg-white" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} />
                                </div>
                            </div>
                            <button disabled={loading} type="submit" className="w-full rounded-2xl bg-primary px-3.5 py-3.5 text-base font-bold text-white shadow-lg shadow-blue-500/30 hover:bg-blue-600 active:scale-[0.98] transition-all mt-2 disabled:opacity-70 flex justify-center">
                                {loading ? <div className="spinner border-white border-b-transparent h-6 w-6"></div> : 'เข้าสู่ระบบ'}
                            </button>
                        </form>
                        <div className="mt-8 flex flex-col items-center gap-6">
                            <p className="text-center text-sm text-slate-500">
                                ยังไม่มีบัญชีสมาชิก?
                                <button onClick={() => onNavigate('register')} className="font-bold text-primary hover:text-blue-600 transition-colors ml-1">สมัครสมาชิก</button>
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        function RegisterScreen({ onNavigate }) {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    const isDemoAdmin = email.toLowerCase().startsWith('admin');
                    await db.collection('users').doc(user.uid).set({
                        name: name,
                        email: email,
                        role: isDemoAdmin ? 'admin' : 'user',
                        status: isDemoAdmin ? 'active' : 'pending',
                        createdAt: new Date()
                    });
                } catch (err) {
                    setError(err.message || 'เกิดข้อผิดพลาดในการสมัครสมาชิก');
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-white flex flex-col">
                    <div className="flex items-center p-4">
                        <button onClick={() => onNavigate('login')} className="w-10 h-10 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors">
                            <Icon name="arrow_back" className="text-slate-800" />
                        </button>
                    </div>
                    <div className="flex flex-col items-center px-6 pt-2 pb-6">
                        <div className="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mb-4 text-primary">
                            <Icon name="person_add" className="text-4xl" />
                        </div>
                        <h1 className="text-2xl font-bold text-[#111418]">สร้างบัญชีผู้ใช้</h1>
                        <p className="text-slate-500 mt-2 text-center">เริ่มต้นเตรียมสอบข้าราชการไปกับเรา</p>
                    </div>
                    <form className="px-6 pb-6 flex flex-col gap-4 max-w-md mx-auto w-full" onSubmit={handleRegister}>
                        {error && <div className="bg-red-50 text-red-500 text-sm p-3 rounded-xl text-center">{error}</div>}
                        <div className="space-y-1">
                            <label className="text-base font-medium text-[#111418]">ชื่อ-นามสกุล</label>
                            <input required className="w-full h-12 rounded-xl border border-slate-200 px-4 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none" placeholder="สมชาย ใจดี" value={name} onChange={(e) => setName(e.target.value)} />
                        </div>
                        <div className="space-y-1">
                            <label className="text-base font-medium text-[#111418]">อีเมล</label>
                            <input required type="email" className="w-full h-12 rounded-xl border border-slate-200 px-4 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none" placeholder="example@email.com" value={email} onChange={(e) => setEmail(e.target.value)} />
                        </div>
                        <div className="space-y-1">
                            <label className="text-base font-medium text-[#111418]">รหัสผ่าน</label>
                            <input required type="password" className="w-full h-12 rounded-xl border border-slate-200 px-4 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none" placeholder="อย่างน้อย 6 ตัวอักษร" value={password} onChange={(e) => setPassword(e.target.value)} />
                        </div>
                        <button disabled={loading} type="submit" className="w-full h-12 bg-primary text-white rounded-xl font-bold text-base shadow-lg shadow-blue-500/20 hover:bg-blue-600 active:scale-[0.98] transition-all flex justify-center items-center">
                            {loading ? <div className="spinner border-white border-b-transparent h-6 w-6"></div> : 'สมัครสมาชิก'}
                        </button>
                    </form>
                </div>
            );
        }

        function PendingApprovalScreen({ onLogout }) {
            return (
                <div className="min-h-screen bg-white flex flex-col items-center justify-center p-6 text-center">
                    <div className="w-24 h-24 bg-orange-50 rounded-full flex items-center justify-center mb-6 text-orange-500">
                        <Icon name="hourglass_empty" className="text-5xl" />
                    </div>
                    <h1 className="text-2xl font-bold text-[#111418] mb-2">รอการอนุมัติ</h1>
                    <p className="text-slate-500 mb-8 max-w-xs">บัญชีของคุณถูกสร้างเรียบร้อยแล้ว<br/>กรุณารอผู้ดูแลระบบตรวจสอบและอนุมัติสิทธิ์การใช้งาน</p>
                    <button onClick={onLogout} className="w-full max-w-xs h-12 rounded-xl border border-slate-200 text-[#111418] font-bold hover:bg-slate-50 transition-colors">
                        กลับสู่หน้าล็อกอิน
                    </button>
                </div>
            );
        }

        function HomeScreen({ user, exams, onNavigate, onStartExam }) {
            const [userStats, setUserStats] = useState({ level: 'ผู้เริ่มต้น', score: 0, examsCount: 0 });
            
            useEffect(() => {
                if (!user) return;
                const unsubscribe = db.collection('exam_results').where('userId', '==', user.uid).onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        setUserStats({ level: 'ผู้เริ่มต้น', score: 0, examsCount: 0 });
                    } else {
                        let totalScore = 0;
                        snapshot.forEach(doc => totalScore += doc.data().score);
                        const avgScore = Math.round(totalScore / snapshot.size);
                        let level = 'ปรับปรุง';
                        if (avgScore >= 90) level = 'ดีเยี่ยม';
                        else if (avgScore >= 80) level = 'ดีมาก';
                        else if (avgScore >= 60) level = 'ดี';
                        setUserStats({ level, score: avgScore, examsCount: snapshot.size });
                    }
                });
                return () => unsubscribe();
            }, [user]);

            return (
                <div className="pb-24 bg-[#f6f7f8] min-h-screen">
                    <header className="flex items-center justify-between bg-white p-4 sticky top-0 z-10 shadow-sm">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => onNavigate('profile')}>
                             <div className="w-10 h-10 rounded-full bg-slate-200 border-2 border-primary/20 flex items-center justify-center overflow-hidden">
                                <Icon name="person" className="text-slate-500" />
                            </div>
                            <div className="flex flex-col">
                                <span className="text-xs text-slate-500 font-medium">ยินดีต้อนรับกลับ</span>
                                <h2 className="text-lg font-bold leading-tight">สวัสดี, {user?.name || 'ผู้เยี่ยมชม'}!</h2>
                            </div>
                        </div>
                        <button className="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-50 transition-colors">
                            <Icon name="notifications" className="text-[#111418]" />
                        </button>
                    </header>
                    <main className="flex flex-col gap-6 px-4 pt-6 max-w-2xl mx-auto w-full">
                        <div className="bg-primary rounded-2xl p-5 shadow-lg shadow-blue-500/20 text-white relative overflow-hidden">
                             <div className="absolute -right-6 -top-6 w-32 h-32 rounded-full bg-white/10 blur-2xl"></div>
                             <div className="relative z-10">
                                <h3 className="text-lg font-bold mb-1">ระดับความสามารถ</h3>
                                <div className="flex items-end gap-4 mb-2">
                                    <span className="text-4xl font-bold">{userStats.level}</span>
                                    <span className="text-sm text-blue-100 mb-1.5">คะแนนเฉลี่ย {userStats.score}%</span>
                                </div>
                                <div className="w-full bg-black/20 rounded-full h-2.5 mb-4 overflow-hidden">
                                    <div className="bg-white h-2.5 rounded-full" style={{ width: `${userStats.score}%` }}></div>
                                </div>
                                <p className="text-xs text-blue-100">จากการทำข้อสอบทั้งหมด {userStats.examsCount} ครั้ง</p>
                             </div>
                        </div>
                        <div className="grid grid-cols-4 gap-4">
                             {[
                                { label: 'เริ่มสอบ', icon: 'play_circle', color: 'bg-blue-50 text-primary', action: () => onNavigate('category') },
                                { label: 'แบบทดสอบ', icon: 'menu_book', color: 'bg-orange-50 text-orange-500', action: () => onNavigate('category') },
                                { label: 'วิดีโอสรุป', icon: 'play_circle', color: 'bg-purple-50 text-purple-500', action: () => onNavigate('video') },
                                { label: 'สรุปเนื้อหา', icon: 'description', color: 'bg-green-50 text-green-600', action: () => onNavigate('summary') }
                            ].map((item, idx) => (
                                <button key={idx} onClick={item.action} className="flex flex-col items-center gap-2 group active:scale-95 transition-transform">
                                    <div className={`w-14 h-14 md:w-16 md:h-16 rounded-2xl flex items-center justify-center ${item.color}`}>
                                        <Icon name={item.icon} className="text-3xl" />
                                    </div>
                                    <span className="text-xs font-medium text-slate-700">{item.label}</span>
                                </button>
                            ))}
                        </div>
                        <div>
                            <div className="flex justify-between items-end mb-4 px-1">
                                <h2 className="text-xl font-bold text-[#111418]">ข้อสอบล่าสุด</h2>
                                <button onClick={() => onNavigate('category')} className="text-sm font-medium text-primary">ดูทั้งหมด</button>
                            </div>
                            <div className="flex overflow-x-auto gap-4 pb-4 -mx-4 px-4 hide-scrollbar snap-x md:grid md:grid-cols-2 md:mx-0 md:px-0">
                                {exams.slice(0, 5).map((exam, i) => (
                                    <div key={exam.id} className="min-w-[280px] snap-center bg-white rounded-xl overflow-hidden shadow-sm border border-slate-100 flex-shrink-0">
                                        <div className="h-32 bg-slate-200 relative flex items-center justify-center">
                                            <Icon name="history_edu" className="text-slate-300 text-5xl" />
                                        </div>
                                        <div className="p-4">
                                            <h3 className="font-bold text-base mb-1 line-clamp-1">{exam.title}</h3>
                                            <p className="text-xs text-slate-500 mb-4">{exam.questions?.length || 0} ข้อ</p>
                                            <button onClick={() => onStartExam(exam)} className="w-full py-2 bg-primary hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-colors">
                                                เริ่มทำข้อสอบ
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>
                    <BottomNav active="home" onNavigate={onNavigate} />
                </div>
            );
        }

        // --- Shared Modals ---
        function ContentReaderModal({ content, onClose }) {
            const embedUrl = content.type === 'video' && content.url ? content.url.replace("watch?v=", "embed/").replace("youtu.be/", "youtube.com/embed/") : content.url;
            let displayUrl = content.url;
            if (content.url.includes('drive.google.com') && content.url.includes('/view')) {
                displayUrl = content.url.replace('/view', '/preview');
            }
            return (
                <div className="fixed inset-0 z-50 bg-black bg-opacity-95 flex flex-col animate-fade-in">
                    <div className="flex justify-between items-center p-4 bg-black text-white">
                        <div className="flex items-center gap-3 overflow-hidden">
                            <button onClick={onClose} className="p-2 bg-white/10 rounded-full hover:bg-white/20"><Icon name="close" /></button>
                            <h3 className="font-bold truncate text-sm">{content.title}</h3>
                        </div>
                        <a href={content.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-1 text-xs bg-primary px-3 py-1.5 rounded-lg hover:bg-blue-600 transition-colors shrink-0">
                            <Icon name="open_in_new" className="text-sm" /> เปิดภายนอก
                        </a>
                    </div>
                    <div className="flex-1 overflow-hidden flex items-center justify-center bg-[#111]">
                        {content.type === 'image' && <img src={content.url} alt={content.title} className="max-w-full max-h-full object-contain" />}
                        {(content.type === 'pdf' || content.type === 'web') && <iframe src={displayUrl} className="w-full h-full border-0 bg-white" title={content.title}></iframe>}
                        {content.type === 'video' && (
                            <div className="w-full h-full md:max-w-4xl md:h-auto md:aspect-video bg-black flex items-center justify-center">
                                <iframe src={embedUrl} className="w-full h-full md:w-full md:h-full border-0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function AddContentModal({ onClose, onSave, defaultType = 'pdf', initialData = null }) {
            const [title, setTitle] = useState(initialData ? initialData.title : '');
            const [url, setUrl] = useState(initialData ? initialData.url : '');
            const [type, setType] = useState(initialData ? initialData.type : defaultType);
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!title || !url) return alert('กรุณากรอกข้อมูลให้ครบ');
                onSave({ title, url, type, createdAt: initialData ? initialData.createdAt : new Date() });
            };
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="bg-white w-full max-w-md mx-4 rounded-xl p-6 shadow-2xl" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">{initialData ? 'แก้ไขเนื้อหา' : 'เพิ่มเนื้อหา'}</h3><button onClick={onClose}><Icon name="close" /></button></div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-medium mb-1">ชื่อหัวข้อ</label><input className="w-full border p-2 rounded-lg" value={title} onChange={e => setTitle(e.target.value)} /></div>
                            <div><label className="block text-sm font-medium mb-1">ประเภท</label><select className="w-full border p-2 rounded-lg" value={type} onChange={e => setType(e.target.value)}><option value="video">วิดีโอ YouTube</option><option value="pdf">ไฟล์ PDF</option><option value="image">รูปภาพ</option><option value="web">เว็บไซต์</option></select></div>
                            <div><label className="block text-sm font-medium mb-1">ลิงก์ (URL)</label><input className="w-full border p-2 rounded-lg" value={url} onChange={e => setUrl(e.target.value)} /></div>
                            <button type="submit" className="w-full bg-primary text-white py-2 rounded-lg font-bold mt-4">บันทึก</button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Video Screen ---
        function VideoScreen({ user, videos, onNavigate }) {
            const [viewingContent, setViewingContent] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const [editingContent, setEditingContent] = useState(null);

            const handleSave = async (data) => {
                if (editingContent) await db.collection('videos').doc(editingContent.id).update(data);
                else await db.collection('videos').add(data);
                setShowAddModal(false);
                setEditingContent(null);
            };

            const handleDelete = async (id) => {
                if (confirm('ลบวิดีโอ?')) await db.collection('videos').doc(id).delete();
            };

            return (
                <div className="flex flex-col min-h-screen bg-[#f6f7f8] pb-24">
                    <div className="sticky top-0 z-20 flex items-center justify-between bg-white p-4 border-b border-slate-100 shadow-sm">
                        <div className="flex items-center gap-2">
                            <button onClick={() => onNavigate('home')}><Icon name="arrow_back" /></button>
                            <h2 className="text-lg font-bold text-[#111418]">วิดีโอสรุป</h2>
                        </div>
                        {user.role === 'admin' && <button onClick={() => {setEditingContent(null); setShowAddModal(true);}} className="bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 shadow-sm"><Icon name="add" className="text-base" /> เพิ่ม</button>}
                    </div>
                    <div className="p-4 max-w-4xl mx-auto w-full">
                        {videos.length === 0 ? <div className="text-center py-10 text-slate-500">ไม่มีวิดีโอ</div> : (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {videos.map((item) => (
                                    <div key={item.id} className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden cursor-pointer group" onClick={() => setViewingContent(item)}>
                                        <div className="aspect-video bg-black relative flex items-center justify-center">
                                            {getYoutubeThumbnail(item.url) ? <img src={getYoutubeThumbnail(item.url)} className="w-full h-full object-cover opacity-80" /> : <Icon name="play_circle" className="text-white text-4xl" />}
                                            <div className="absolute inset-0 flex items-center justify-center"><div className="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center text-white"><Icon name="play_arrow" /></div></div>
                                        </div>
                                        <div className="p-3 flex justify-between items-start gap-2">
                                            <h4 className="font-bold text-sm line-clamp-2">{item.title}</h4>
                                            {user.role === 'admin' && (
                                                <div className="flex gap-2">
                                                    <button onClick={(e) => { e.stopPropagation(); setEditingContent(item); setShowAddModal(true); }} className="text-slate-400 hover:text-primary"><Icon name="edit" className="text-sm" /></button>
                                                    <button onClick={(e) => { e.stopPropagation(); handleDelete(item.id); }} className="text-slate-400 hover:text-red-500"><Icon name="delete" className="text-sm" /></button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    {showAddModal && <AddContentModal onClose={() => setShowAddModal(false)} onSave={handleSave} defaultType="video" initialData={editingContent} />}
                    {viewingContent && <ContentReaderModal content={viewingContent} onClose={() => setViewingContent(null)} />}
                    <BottomNav active="video" onNavigate={onNavigate} />
                </div>
            );
        }

        // --- Summary Screen ---
        function SummaryScreen({ user, summaries, onNavigate }) {
            const [viewingContent, setViewingContent] = useState(null);
            const [showAddModal, setShowAddModal] = useState(false);
            const [editingContent, setEditingContent] = useState(null);

            const handleSave = async (data) => {
                if (editingContent) await db.collection('summaries').doc(editingContent.id).update(data);
                else await db.collection('summaries').add(data);
                setShowAddModal(false);
                setEditingContent(null);
            };

            const handleDelete = async (id) => {
                if (confirm('ลบเนื้อหา?')) await db.collection('summaries').doc(id).delete();
            };

            return (
                <div className="flex flex-col min-h-screen bg-[#f6f7f8] pb-24">
                    <div className="sticky top-0 z-20 flex items-center justify-between bg-white p-4 border-b border-slate-100 shadow-sm">
                        <div className="flex items-center gap-2">
                            <button onClick={() => onNavigate('home')}><Icon name="arrow_back" /></button>
                            <h2 className="text-lg font-bold">สรุปเนื้อหา</h2>
                        </div>
                        {user.role === 'admin' && <button onClick={() => {setEditingContent(null); setShowAddModal(true);}} className="bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1"><Icon name="add" className="text-base" /> เพิ่ม</button>}
                    </div>
                    <div className="p-4 max-w-4xl mx-auto w-full">
                        {summaries.length === 0 ? <div className="text-center py-10 text-slate-500">ไม่มีเอกสาร</div> : (
                            <div className="flex flex-col gap-3">
                                {summaries.map((item) => (
                                    <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between cursor-pointer" onClick={() => setViewingContent(item)}>
                                        <div className="flex items-center gap-4 overflow-hidden">
                                            <div className={`w-12 h-12 rounded-lg flex items-center justify-center shrink-0 ${item.type === 'pdf' ? 'bg-red-50 text-red-500' : 'bg-blue-50 text-blue-500'}`}>
                                                <Icon name={item.type === 'pdf' ? 'picture_as_pdf' : 'article'} />
                                            </div>
                                            <div className="min-w-0">
                                                <h4 className="font-bold truncate pr-2">{item.title}</h4>
                                                <p className="text-xs text-slate-500 uppercase">{item.type}</p>
                                            </div>
                                        </div>
                                        {user.role === 'admin' && (
                                            <div className="flex gap-1">
                                                <button onClick={(e) => { e.stopPropagation(); setEditingContent(item); setShowAddModal(true); }} className="p-2 text-slate-300 hover:text-primary"><Icon name="edit" /></button>
                                                <button onClick={(e) => { e.stopPropagation(); handleDelete(item.id); }} className="p-2 text-slate-300 hover:text-red-500"><Icon name="delete" /></button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    {showAddModal && <AddContentModal onClose={() => setShowAddModal(false)} onSave={handleSave} initialData={editingContent} />}
                    {viewingContent && <ContentReaderModal content={viewingContent} onClose={() => setViewingContent(null)} />}
                    <BottomNav active="summary" onNavigate={onNavigate} />
                </div>
            );
        }

        // --- Category Screen ---
        function CategoryScreen({ exams, onNavigate, onStartExam }) {
            const [activeTab, setActiveTab] = useState('part_a');
            const filteredExams = exams.filter(exam => (exam.category || 'part_a') === activeTab);

            return (
                <div className="flex flex-col min-h-screen bg-[#f6f7f8]">
                    <div className="sticky top-0 z-20 bg-white shadow-sm">
                        <div className="flex items-center p-4 border-b border-slate-100">
                            <button onClick={() => onNavigate('home')} className="mr-3"><Icon name="arrow_back" /></button>
                            <h2 className="text-lg font-bold">แบบทดสอบ</h2>
                        </div>
                        <div className="flex">
                            <button onClick={() => setActiveTab('part_a')} className={`flex-1 py-3 text-sm font-bold border-b-2 ${activeTab === 'part_a' ? 'border-primary text-primary bg-blue-50/50' : 'border-transparent text-slate-500'}`}>ภาค ก (ความรู้ทั่วไป)</button>
                            <button onClick={() => setActiveTab('part_b')} className={`flex-1 py-3 text-sm font-bold border-b-2 ${activeTab === 'part_b' ? 'border-primary text-primary bg-blue-50/50' : 'border-transparent text-slate-500'}`}>ภาค ข (วิชาเฉพาะ)</button>
                        </div>
                    </div>
                    <div className="p-4 max-w-4xl mx-auto w-full">
                        {filteredExams.length === 0 ? <div className="text-center py-10 text-slate-500">ไม่มีข้อสอบ</div> : (
                            <div className="flex flex-col gap-3">
                                {filteredExams.map((exam) => (
                                    <div key={exam.id} onClick={() => onStartExam(exam)} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md cursor-pointer flex items-center justify-between">
                                        <div className="flex items-center gap-4">
                                            <div className={`w-12 h-12 rounded-lg flex items-center justify-center ${activeTab === 'part_a' ? 'bg-blue-50 text-blue-600' : 'bg-orange-50 text-orange-600'}`}><Icon name="description" /></div>
                                            <div><h4 className="font-bold mb-1">{exam.title}</h4><p className="text-xs text-slate-500">{exam.questions?.length || 0} ข้อ • {Math.floor((exam.timeLimit || 1800) / 60)} นาที</p></div>
                                        </div>
                                        <Icon name="chevron_right" className="text-slate-400" />
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <BottomNav active="category" onNavigate={onNavigate} />
                </div>
            );
        }

        function HistoryScreen({ user, onNavigate }) {
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user) return;
                db.collection('exam_results').where('userId', '==', user.uid).orderBy('date', 'desc').get()
                    .then(snap => {
                        setHistory(snap.docs.map(doc => ({ id: doc.id, ...doc.data(), dateString: doc.data().date?.toDate().toLocaleDateString('th-TH') })));
                        setLoading(false);
                    });
            }, [user]);

            return (
                <div className="min-h-screen bg-[#f6f7f8] pb-24">
                    <div className="sticky top-0 z-20 flex items-center justify-between bg-white p-4 border-b border-slate-100 shadow-sm">
                        <button onClick={() => onNavigate('home')}><Icon name="arrow_back" /></button>
                        <h1 className="text-lg font-bold">ประวัติการสอบ</h1>
                        <div className="w-8"></div>
                    </div>
                    {loading ? <LoadingSpinner /> : (
                        <div className="px-4 py-4 flex flex-col gap-3">
                            {history.length === 0 ? <div className="text-center text-slate-500 mt-10">ไม่มีประวัติ</div> : history.map((item) => (
                                <div key={item.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col gap-3">
                                    <div className="flex justify-between items-start">
                                        <div className="flex gap-3">
                                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${item.status === 'pass' ? 'bg-blue-50 text-primary' : 'bg-red-50 text-red-500'}`}><Icon name="description" /></div>
                                            <div><h4 className="font-bold text-sm">{item.examTitle}</h4><p className="text-xs text-slate-500">วันที่ {item.dateString}</p></div>
                                        </div>
                                        <span className={`px-2 py-1 rounded-lg text-xs font-bold ${item.status === 'pass' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{item.score}%</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    <BottomNav active="history" onNavigate={onNavigate} />
                </div>
            );
        }

        function ProfileScreen({ user, onNavigate, onLogout }) {
            return (
                <div className="min-h-screen bg-[#f6f7f8] pb-24">
                    <div className="bg-white pb-4">
                        <div className="flex items-center justify-between p-4"><button onClick={() => onNavigate('home')}><Icon name="arrow_back" /></button><h2 className="text-lg font-bold">โปรไฟล์</h2><div className="w-6"></div></div>
                        <div className="flex flex-col items-center gap-3">
                            <div className="w-24 h-24 rounded-full bg-slate-200 border-4 border-white shadow-md flex items-center justify-center"><span className="text-4xl text-slate-400 font-bold">{user?.name?.charAt(0)}</span></div>
                            <div className="text-center"><h3 className="text-xl font-bold">{user?.name}</h3><p className="text-sm text-slate-500">{user?.email}</p></div>
                        </div>
                    </div>
                    <div className="mt-4 px-4"><button onClick={onLogout} className="w-full py-3 text-red-600 font-bold bg-white rounded-xl shadow-sm border border-slate-200">ออกจากระบบ</button></div>
                    <BottomNav active="profile" onNavigate={onNavigate} />
                </div>
            );
        }

        function ExamScreen({ examData, examState, onAnswer, onNext, onNavigate }) {
            const currentQ = examData.questions[examState.currentQuestionIndex];
            const hasAnswered = !!examState.answers[currentQ.id];
            const isCorrect = hasAnswered && normalizeAnswer(examState.answers[currentQ.id]) === normalizeAnswer(currentQ.correct);
            const formatTime = (seconds) => `${Math.floor(seconds/60).toString().padStart(2,'0')}:${(seconds%60).toString().padStart(2,'0')}`;
            return (
                <div className="flex flex-col h-screen bg-white">
                    <header className="flex-none flex items-center justify-between p-4 border-b border-slate-100"><button onClick={() => onNavigate('home')}><Icon name="close" /></button><h2 className="font-bold text-lg truncate pr-2 max-w-[200px]">{examData.title}</h2><div className="w-6"></div></header>
                    <div className="flex-none px-4 py-3 bg-white shadow-sm z-10">
                        <div className="flex justify-between items-center mb-2 max-w-2xl mx-auto w-full"><div className="flex items-center gap-2 text-primary font-bold"><Icon name="timer" /><span className="tabular-nums">{formatTime(examState.timeRemaining)}</span></div><span className="text-xs text-slate-500 font-medium">ข้อ {examState.currentQuestionIndex+1}/{examData.questions.length}</span></div>
                        <div className="max-w-2xl mx-auto w-full bg-slate-100 h-1.5 rounded-full overflow-hidden"><div className="bg-primary h-full transition-all" style={{ width: `${((examState.currentQuestionIndex + 1) / examData.questions.length) * 100}%` }}></div></div>
                    </div>
                    <main className="flex-1 overflow-y-auto p-4 pb-20">
                        <div className="flex flex-col gap-4 max-w-2xl mx-auto w-full">
                            <h2 className="text-xl font-bold leading-snug">{currentQ.question}</h2>
                            <div className="flex flex-col gap-3">
                                {currentQ.options.map((opt) => {
                                    const isSelected = examState.answers[currentQ.id] === opt.id;
                                    const isCorrectOpt = normalizeAnswer(currentQ.correct) === normalizeAnswer(opt.id);
                                    let cls = "border-slate-200";
                                    if (hasAnswered) {
                                        if (isCorrectOpt) cls = "border-green-500 bg-green-50";
                                        else if (isSelected) cls = "border-red-500 bg-red-50";
                                        else cls = "border-slate-200 opacity-60";
                                    } else if (isSelected) cls = "border-primary bg-primary/5";
                                    return (
                                        <label key={opt.id} className={`flex items-center gap-4 p-4 rounded-xl border cursor-pointer transition-all ${cls}`}>
                                            <input type="radio" className="hidden" onChange={() => onAnswer(currentQ.id, opt.id)} checked={isSelected} disabled={hasAnswered} />
                                            <span className="text-base font-medium">{opt.text}</span>
                                        </label>
                                    );
                                })}
                            </div>
                            {hasAnswered && (
                                <div className={`mt-4 p-4 rounded-xl border ${isCorrect ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'} animate-fade-in`}>
                                    <h3 className={`font-bold mb-1 ${isCorrect ? 'text-green-700' : 'text-red-700'}`}>{isCorrect ? "ถูกต้อง!" : "ไม่ถูกนะ"}</h3>
                                    <p className="text-sm">{currentQ.explanation}</p>
                                </div>
                            )}
                        </div>
                    </main>
                    <footer className="flex-none p-4 border-t border-slate-100 bg-white">
                        <div className="max-w-2xl mx-auto w-full">{hasAnswered ? <button onClick={onNext} className="w-full h-12 rounded-xl bg-primary text-white font-bold">{examState.currentQuestionIndex === examData.questions.length-1 ? 'ดูผลสอบ' : 'ข้อถัดไป'}</button> : <div className="text-center text-slate-400">เลือกคำตอบ</div>}</div>
                    </footer>
                </div>
            );
        }

        function ResultScreen({ examState, totalQuestions, onNavigate }) {
            const score = examState.score || 0;
            const isPassed = score >= 60;
            return (
                <div className="min-h-screen bg-[#f6f7f8] flex flex-col items-center p-6">
                    <div className="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden mt-8 animate-fade-in">
                        <div className={`p-8 text-center ${isPassed ? 'bg-green-50' : 'bg-red-50'}`}>
                            <div className={`w-24 h-24 mx-auto rounded-full flex items-center justify-center mb-4 ${isPassed ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}><Icon name={isPassed ? "emoji_events" : "sentiment_dissatisfied"} className="text-5xl" /></div>
                            <h2 className={`text-3xl font-bold ${isPassed ? 'text-green-700' : 'text-red-700'}`}>{isPassed ? "สอบผ่าน" : "สอบไม่ผ่าน"}</h2>
                        </div>
                        <div className="p-8">
                            <div className="flex justify-between items-center mb-6">
                                <div className="text-center flex-1"><p className="text-xs text-slate-400 font-bold mb-1">คะแนน</p><p className="text-4xl font-black">{score}%</p></div>
                                <div className="w-px h-12 bg-slate-100"></div>
                                <div className="text-center flex-1"><p className="text-xs text-slate-400 font-bold mb-1">ข้อที่ถูก</p><p className="text-4xl font-black">{Math.round((score/100)*totalQuestions)}/{totalQuestions}</p></div>
                            </div>
                            <button onClick={() => onNavigate('home')} className="w-full py-4 bg-primary text-white rounded-2xl font-bold mb-3">กลับหน้าหลัก</button>
                            <button onClick={() => onNavigate('history')} className="w-full py-4 bg-slate-100 text-slate-700 rounded-2xl font-bold">ดูประวัติ</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Admin Components ---
        function AdminExamScreen({ exams, videos, summaries, onNavigate }) {
            const [activeTab, setActiveTab] = useState('exams');
            const [viewMode, setViewMode] = useState('list');
            const [editorData, setEditorData] = useState({ id: null, title: '', questions: [], category: 'part_a', timeLimit: 60 });
            const [showContentModal, setShowContentModal] = useState(false);
            const [editingContent, setEditingContent] = useState(null);

            const handleSaveExam = async () => {
                const data = { title: editorData.title, questions: editorData.questions, timeLimit: editorData.timeLimit*60, category: editorData.category, createdAt: new Date() };
                if (editorData.id) await db.collection('exams').doc(editorData.id).update(data);
                else await db.collection('exams').add(data);
                setViewMode('list');
            };

            const handleSaveContent = async (data) => {
                const coll = activeTab === 'videos' ? 'videos' : 'summaries';
                if (editingContent) await db.collection(coll).doc(editingContent.id).update(data);
                else await db.collection(coll).add(data);
                setShowContentModal(false);
            };

            if (viewMode === 'list') return (
                <div className="pb-24 bg-[#f6f7f8] min-h-screen">
                    <div className="bg-white border-b shadow-sm sticky top-0 z-10">
                        <div className="flex items-center justify-between p-4">
                            <h2 className="text-lg font-bold">จัดการเนื้อหา</h2>
                            <button onClick={() => activeTab === 'exams' ? setViewMode('editor') : setShowContentModal(true)} className="bg-admin-primary text-white px-3 py-1 rounded-lg text-sm font-bold flex items-center gap-1"><Icon name="add" className="text-base" /> เพิ่ม</button>
                        </div>
                        <div className="flex px-4 gap-6">
                            <button onClick={() => setActiveTab('exams')} className={`pb-2 text-sm font-bold border-b-2 ${activeTab === 'exams' ? 'border-primary text-primary' : 'border-transparent text-slate-400'}`}>ข้อสอบ</button>
                            <button onClick={() => setActiveTab('videos')} className={`pb-2 text-sm font-bold border-b-2 ${activeTab === 'videos' ? 'border-primary text-primary' : 'border-transparent text-slate-400'}`}>วิดีโอ</button>
                            <button onClick={() => setActiveTab('summaries')} className={`pb-2 text-sm font-bold border-b-2 ${activeTab === 'summaries' ? 'border-primary text-primary' : 'border-transparent text-slate-400'}`}>สรุป</button>
                        </div>
                    </div>
                    <div className="p-4 flex flex-col gap-3">
                        {activeTab === 'exams' && exams.map(e => (
                            <div key={e.id} className="bg-white p-4 rounded-xl border flex justify-between items-center">
                                <div><h4 className="font-bold">{e.title}</h4><p className="text-xs text-slate-500">{e.questions?.length} ข้อ</p></div>
                                <div className="flex gap-2"><button onClick={() => { setEditorData({...e, timeLimit: e.timeLimit/60}); setViewMode('editor'); }}><Icon name="edit" /></button></div>
                            </div>
                        ))}
                        {activeTab !== 'exams' && (activeTab === 'videos' ? videos : summaries).map(item => (
                            <div key={item.id} className="bg-white p-4 rounded-xl border flex justify-between items-center">
                                <div><h4 className="font-bold truncate max-w-[200px]">{item.title}</h4><p className="text-xs text-slate-500 uppercase">{item.type}</p></div>
                                <button onClick={() => {setEditingContent(item); setShowContentModal(true);}}><Icon name="edit" /></button>
                            </div>
                        ))}
                    </div>
                    {showContentModal && <AddContentModal onClose={() => setShowContentModal(false)} onSave={handleSaveContent} initialData={editingContent} defaultType={activeTab === 'videos' ? 'video' : 'pdf'} />}
                    <AdminBottomNav active="admin-exams" onNavigate={onNavigate} />
                </div>
            );

            return (
                <div className="bg-[#f6f7f8] min-h-screen">
                    <div className="sticky top-0 z-20 bg-white p-4 border-b flex items-center justify-between">
                        <div className="flex items-center gap-2"><button onClick={() => setViewMode('list')}><Icon name="arrow_back" /></button><h2 className="text-lg font-bold">แก้ไขข้อสอบ</h2></div>
                        <button onClick={handleSaveExam} className="bg-primary text-white px-4 py-1.5 rounded-lg font-bold">บันทึก</button>
                    </div>
                    <div className="p-4 space-y-4">
                        <input className="w-full text-lg font-bold border-b py-2 outline-none" value={editorData.title} onChange={e => setEditorData({...editorData, title: e.target.value})} placeholder="ชื่อชุดข้อสอบ" />
                        <select className="w-full border p-2 rounded-lg" value={editorData.category} onChange={e => setEditorData({...editorData, category: e.target.value})}><option value="part_a">ภาค ก</option><option value="part_b">ภาค ข</option></select>
                        <input type="number" className="w-full border p-2 rounded-lg" value={editorData.timeLimit} onChange={e => setEditorData({...editorData, timeLimit: e.target.value})} placeholder="เวลา (นาที)" />
                    </div>
                </div>
            );
        }

        function AdminHomeScreen({ user, stats, onNavigate, onLogout }) {
            return (
                <div className="pb-24 bg-[#f6f7f8] min-h-screen">
                    <header className="bg-white p-4 sticky top-0 z-10 shadow-sm flex items-center justify-between">
                        <div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-admin-primary text-white flex items-center justify-center"><Icon name="admin_panel_settings" /></div><div><h2 className="text-lg font-bold text-admin-primary">{user?.name}</h2><p className="text-xs">Admin Panel</p></div></div>
                        <button onClick={onLogout}><Icon name="logout" /></button>
                    </header>
                    <main className="p-4 grid grid-cols-2 gap-3">
                        <div className="bg-white p-4 rounded-xl border"><p className="text-slate-500 text-xs">ข้อสอบทั้งหมด</p><p className="text-2xl font-bold">{stats.exams}</p></div>
                        <div className="bg-white p-4 rounded-xl border"><p className="text-slate-500 text-xs">สถานะระบบ</p><p className="text-2xl font-bold text-green-500">ปกติ</p></div>
                    </main>
                    <AdminBottomNav active="admin-home" onNavigate={onNavigate} />
                </div>
            );
        }

        function AdminUserScreen({ onNavigate, currentUser }) {
            const [users, setUsers] = useState([]);
            useEffect(() => {
                const unsub = db.collection('users').onSnapshot(snap => setUsers(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                return () => unsub();
            }, []);
            const approve = (id) => db.collection('users').doc(id).update({ status: 'active' });
            return (
                <div className="pb-24 bg-[#f6f7f8] min-h-screen">
                    <div className="bg-white p-4 border-b sticky top-0 z-10"><h2 className="text-lg font-bold">จัดการผู้ใช้</h2></div>
                    <div className="p-4 flex flex-col gap-3">
                        {users.map(u => (
                            <div key={u.id} className="bg-white p-4 rounded-xl border flex justify-between items-center">
                                <div><h4 className="font-bold">{u.name}</h4><p className="text-xs">{u.email}</p></div>
                                {u.status === 'pending' && <button onClick={() => approve(u.id)} className="bg-green-600 text-white px-3 py-1 rounded-lg text-xs font-bold">อนุมัติ</button>}
                            </div>
                        ))}
                    </div>
                    <AdminBottomNav active="admin-users" onNavigate={onNavigate} />
                </div>
            );
        }

        function BottomNav({ active, onNavigate }) {
            const nav = [{ id: 'home', icon: 'home', label: 'หน้าหลัก' }, { id: 'category', icon: 'menu_book', label: 'วิชาสอบ' }, { id: 'history', icon: 'bar_chart', label: 'ประวัติ' }, { id: 'profile', icon: 'person', label: 'โปรไฟล์' }];
            return <div className="fixed bottom-0 w-full bg-white border-t px-6 py-2 flex justify-between items-center z-50 max-w-[inherit]">{nav.map(n => <button key={n.id} onClick={() => onNavigate(n.id)} className={`flex flex-col items-center gap-1 p-2 ${active === n.id ? 'text-primary' : 'text-slate-400'}`}><Icon name={n.icon} /><span className="text-[10px] font-medium">{n.label}</span></button>)}</div>;
        }

        function AdminBottomNav({ active, onNavigate }) {
            const nav = [{ id: 'admin-home', icon: 'dashboard', label: 'ภาพรวม' }, { id: 'admin-exams', icon: 'library_books', label: 'ข้อสอบ' }, { id: 'admin-users', icon: 'group', label: 'ผู้ใช้' }, { id: 'home', icon: 'visibility', label: 'ดูหน้าเว็บ' }];
            return <div className="fixed bottom-0 w-full bg-white border-t px-6 py-2 flex justify-between items-center z-50 max-w-[inherit]">{nav.map(n => <button key={n.id} onClick={() => onNavigate(n.id)} className={`flex flex-col items-center gap-1 p-2 ${active === n.id ? 'text-admin-primary' : 'text-slate-400'}`}><Icon name={n.icon} /><span className="text-[10px] font-medium">{n.label}</span></button>)}</div>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
