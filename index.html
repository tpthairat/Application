<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TheONE สอบราชการ</title>

<!-- Fonts / Icons -->
<link href="https://fonts.googleapis.com/css2?family=Public+Sans&family=Noto+Sans+Thai&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

<!-- Tailwind CDN (ของเดิม) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- React (ของเดิม) -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

/* ======================================================
   Firebase Init
====================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyDaSXAda-YiHCgsCJzQA_bnPLZKOoOy0Ek",
  authDomain: "application-b08ac.firebaseapp.com",
  projectId: "application-b08ac",
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

// ✅ FIX 1: ปิด Firestore Persistence (ลบ cache ปัญหา)
const auth = firebase.auth();
const db = firebase.firestore();

/* ======================================================
   Utilities (ของเดิม)
====================================================== */
const normalizeAnswer = (ans) => {
  if (!ans) return '';
  const map = { '1':'A','2':'B','3':'C','4':'D','ก':'A','ข':'B','ค':'C','ง':'D' };
  return map[String(ans).trim()] || ans;
};

/* ======================================================
   App
====================================================== */
const { useState, useEffect } = React;

function App() {
  const [user, setUser] = useState(null);
  const [screen, setScreen] = useState('loading');

  useEffect(() => {
    const unsub = auth.onAuthStateChanged(async (u) => {
      if (!u) {
        setUser(null);
        setScreen('login');
        return;
      }

      try {
        const doc = await db.collection('users').doc(u.uid).get();
        if (!doc.exists) {
          await auth.signOut();
          setScreen('login');
          return;
        }
        setUser({ uid: u.uid, ...doc.data() });
        setScreen(doc.data().role === 'admin' ? 'admin-home' : 'home');
      } catch (e) {
        console.error(e);
        setScreen('login');
      }
    });
    return () => unsub();
  }, []);

  if (screen === 'loading') return <div>Loading...</div>;
  if (screen === 'login') return <Login />;

  return <Home user={user} />;
}

/* ======================================================
   Login (ของเดิม)
====================================================== */
function Login() {
  const [email,setEmail] = useState('');
  const [password,setPassword] = useState('');

  const login = async () => {
    await auth.signInWithEmailAndPassword(email,password);
  };

  return (
    <div>
      <input onChange={e=>setEmail(e.target.value)} />
      <input type="password" onChange={e=>setPassword(e.target.value)} />
      <button onClick={login}>Login</button>
    </div>
  );
}

/* ======================================================
   Home (แก้ onSnapshot → get)
====================================================== */
function Home({ user }) {
  const [exams, setExams] = useState([]);
  const [loading, setLoading] = useState(true);

  // ✅ FIX 2: ใช้ get() แทน onSnapshot
  useEffect(() => {
    const fetchExams = async () => {
      try {
        const snap = await db.collection('exams')
          .orderBy('createdAt','desc')
          .limit(5)
          .get();

        setExams(snap.docs.map(d => ({ id:d.id, ...d.data() })));
      } catch (e) {
        console.error(e);
      } finally {
        setLoading(false);
      }
    };
    fetchExams();
  }, []);

  if (loading) return <div>Loading exams...</div>;

  return (
    <div>
      <h1>สวัสดี {user.name}</h1>
      {exams.map(e => (
        <div key={e.id}>
          <b>{e.title}</b> ({e.questions?.length || 0} ข้อ)
        </div>
      ))}
    </div>
  );
}

/* ======================================================
   History (แก้ user sync)
====================================================== */
function History({ user }) {
  const [items,setItems] = useState([]);

  useEffect(() => {
    if (!user?.uid) return; // ✅ FIX 3

    const fetch = async () => {
      const snap = await db.collection('exam_results')
        .where('userId','==',user.uid)
        .orderBy('date','desc')
        .get();

      setItems(snap.docs.map(d=>d.data()));
    };

    fetch();
  }, [user?.uid]);

  return <pre>{JSON.stringify(items,null,2)}</pre>;
}

/* ======================================================
   Render
====================================================== */
ReactDOM.createRoot(document.getElementById('root')).render(<App />);

</script>
</body>
</html>
