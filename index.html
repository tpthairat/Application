<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Civil Service Exam Prep (User Level)</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material Symbols (Icons) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "admin-primary": "#7c3aed",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "Noto Sans Thai", "sans-serif"],
                        "body": ["Public Sans", "Noto Sans Thai", "sans-serif"],
                    },
                },
            },
        }
    </script>

    <!-- React & ReactDOM & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Public Sans', 'Noto Sans Thai', sans-serif; background-color: #f3f4f6; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #app-container {
            max-width: 100%;
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        
        @media (min-width: 768px) {
            #app-container { max-width: 768px; }
        }
        
        @media (min-width: 1024px) {
            body { padding: 0; display: flex; justify-content: center; }
            #app-container { max-width: 600px; min-height: 100vh; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; }
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #137fec;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal Overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body class="antialiased">
    <div id="root" class="w-full"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDaSXAda-YiHCgsCJzQA_bnPLZKOoOy0Ek",
            authDomain: "application-b08ac.firebaseapp.com",
            databaseURL: "https://application-b08ac-default-rtdb.firebaseio.com",
            projectId: "application-b08ac",
            storageBucket: "application-b08ac.firebasestorage.app",
            messagingSenderId: "303359329226",
            appId: "1:303359329226:web:ca24a7031e2418f5148533",
            measurementId: "G-J469TY8LN1"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            firebase.firestore().enablePersistence().catch(err => {
                console.log('Persistence disabled or error:', err.code);
            });
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Utility: Normalize Answers ---
        const normalizeAnswer = (ans) => {
            if (!ans) return '';
            const str = String(ans).trim().toUpperCase();
            const map = {
                '1': 'A', 'ก': 'A', 'A': 'A',
                '2': 'B', 'ข': 'B', 'B': 'B',
                '3': 'C', 'ค': 'C', 'C': 'C',
                '4': 'D', 'ง': 'D', 'D': 'D'
            };
            return map[str] || str;
        };

        // --- Mock Data ---
        const INITIAL_MOCK_EXAM = {
            title: "แนวข้อสอบ ก.พ. ภาค ก. (ตัวอย่าง)",
            subject: "วิชากฎหมายและระเบียบข้าราชการ",
            timeLimit: 30 * 60,
            questions: [
                 { id: 1, question: "ข้อใดต่อไปนี้ ไม่ใช่ หลักธรรมาภิบาล?", options: [{ id: 'A', text: "ก. หลักนิติธรรม" }, { id: 'B', text: "ข. หลักคุณธรรม" }, { id: 'C', text: "ค. หลักความลับ" }, { id: 'D', text: "ง. หลักความโปร่งใส" }], correct: 'C', explanation: "หลักความลับไม่ใช่หลักธรรมาภิบาล ตามระเบียบสำนักนายกรัฐมนตรีว่าด้วยการสร้างระบบบริหารกิจการบ้านเมืองและสังคมที่ดี พ.ศ. 2542" }
            ]
        };

        // --- Helper Components ---
        function Icon({ name, className = "", style = {} }) {
            return <span className={`material-symbols-outlined ${className}`} style={style}>{name}</span>;
        }

        function LoadingSpinner() {
            return (
                <div className="flex justify-center items-center h-full w-full py-10">
                    <div className="spinner"></div>
                </div>
            );
        }

        // --- Main App ---
        function App() {
            const [currentScreen, setCurrentScreen] = useState('loading'); 
            const [user, setUser] = useState(null);
            const [selectedExam, setSelectedExam] = useState(null);
            const [examState, setExamState] = useState({
                answers: {},
                currentQuestionIndex: 0,
                isFinished: false,
                score: 0,
                timeRemaining: 0,
                feedbackMode: false 
            });

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
                    if (authUser) {
                        try {
                            const userDoc = await db.collection('users').doc(authUser.uid).get();
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                setUser({ uid: authUser.uid, email: authUser.email, ...userData });
                                if (userData.status === 'pending') setCurrentScreen('pending-approval');
                                else if (userData.role === 'admin') setCurrentScreen('admin-home');
                                else setCurrentScreen('home');
                            } else {
                                await auth.signOut();
                                alert('ไม่พบข้อมูลผู้ใช้ในระบบ หรือบัญชีถูกลบ');
                                setCurrentScreen('login');
                            }
                        } catch (error) {
                            console.error("Auth Error:", error);
                            setCurrentScreen('login');
                        }
                    } else {
                        setUser(null);
                        setCurrentScreen('login');
                    }
                });
                return () => unsubscribe();
            }, []);

            const navigate = (screen) => {
                window.scrollTo(0, 0);
                setCurrentScreen(screen);
            };

            const handleLogout = async () => {
                await auth.signOut();
                navigate('login');
            };

            const startExam = (examData) => {
                setSelectedExam(examData);
                setExamState({
                    answers: {},
                    currentQuestionIndex: 0,
                    isFinished: false,
                    score: 0,
                    timeRemaining: examData.timeLimit || 30 * 60,
                    feedbackMode: false
                });
                navigate('exam');
            };

            const handleAnswer = (questionId, optionId) => {
                if (examState.answers[questionId]) return;
                setExamState(prev => ({
                    ...prev,
                    answers: { ...prev.answers, [questionId]: optionId },
                    feedbackMode: true 
                }));
            };

            const handleNextQuestion = () => {
                if (examState.currentQuestionIndex < selectedExam.questions.length - 1) {
                    setExamState(prev => ({
                        ...prev,
                        currentQuestionIndex: prev.currentQuestionIndex + 1,
                        feedbackMode: false 
                    }));
                } else {
                    submitExam();
                }
            };

            const submitExam = async () => {
                let correctCount = 0;
                selectedExam.questions.forEach(q => {
                    if (normalizeAnswer(examState.answers[q.id]) === normalizeAnswer(q.correct)) correctCount++;
                });
                const scorePercentage = Math.round((correctCount / selectedExam.questions.length) * 100);
                
                if (user) {
                    try {
                        await db.collection('exam_results').add({
                            userId: user.uid,
                            examTitle: selectedExam.title,
                            score: scorePercentage,
                            date: new Date(),
                            status: scorePercentage >= 60 ? 'pass' : 'fail'
                        });
                    } catch (e) { console.error("Error saving exam:", e); }
                }

                setExamState(prev => ({ ...prev, isFinished: true, score: scorePercentage }));
                navigate('result');
            };

            useEffect(() => {
                let interval;
                if (currentScreen === 'exam' && !examState.isFinished && examState.timeRemaining > 0) {
                    interval = setInterval(() => {
                        setExamState(prev => {
                            if (prev.timeRemaining <= 1) {
                                clearInterval(interval);
                                submitExam();
                                return { ...prev, timeRemaining: 0 };
                            }
                            return { ...prev, timeRemaining: prev.timeRemaining - 1 };
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [currentScreen, examState.isFinished]);

            if (currentScreen === 'loading') return <div className="min-h-screen flex items-center justify-center bg-white"><div className="spinner"></div></div>;

            return (
                <div id="app-container">
                    {currentScreen === 'login' && <LoginScreen onNavigate={navigate} />}
                    {currentScreen === 'register' && <RegisterScreen onNavigate={navigate} />}
                    {currentScreen === 'pending-approval' && <PendingApprovalScreen onLogout={handleLogout} />}
                    
                    {currentScreen === 'home' && <HomeScreen user={user} onNavigate={navigate} onStartExam={startExam} />}
                    {currentScreen === 'category' && <CategoryScreen onNavigate={navigate} onStartExam={startExam} />}
                    {currentScreen === 'summary' && <SummaryScreen user={user} onNavigate={navigate} />}
                    {currentScreen === 'history' && <HistoryScreen user={user} onNavigate={navigate} />}
                    {currentScreen === 'profile' && <ProfileScreen user={user} onNavigate={navigate} onLogout={handleLogout} />}
                    
                    {currentScreen === 'exam' && selectedExam && (
                        <ExamScreen 
                            examData={selectedExam} 
                            examState={examState} 
                            onAnswer={handleAnswer} 
                            onNext={handleNextQuestion}
                            onSubmit={submitExam}
                            onNavigate={navigate}
                        />
                    )}
                    
                    {currentScreen === 'result' && selectedExam && (
                        <ResultScreen 
                            examState={examState} 
                            totalQuestions={selectedExam.questions.length}
                            onNavigate={navigate}
                        />
                    )}
                    
                    {currentScreen === 'admin-home' && user?.role === 'admin' && <AdminHomeScreen user={user} onNavigate={navigate} onLogout={handleLogout} />}
                    {currentScreen === 'admin-exams' && user?.role === 'admin' && <AdminExamScreen onNavigate={navigate} />}
                    {currentScreen === 'admin-users' && user?.role === 'admin' && <AdminUserScreen onNavigate={navigate} currentUser={user} />}
                </div>
            );
        }

        // --- Screen Components ---

        function LoginScreen({ onNavigate }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    setError('อีเมลหรือรหัสผ่านไม่ถูกต้อง');
                    setLoading(false);
                }
            };
            
            return (
                <div className="flex flex-col items-center justify-center min-h-screen px-6 relative overflow-hidden bg-white">
                    <div className="absolute top-[-10%] right-[-5%] w-72 h-72 bg-primary/10 rounded-full blur-3xl"></div>
                    <div className="absolute bottom-[-10%] left-[-5%] w-72 h-72 bg-blue-400/10 rounded-full blur-3xl"></div>
                    <div className="w-full max-w-sm z-10">
                        <div className="flex flex-col items-center mb-10">
                            <div className="w-16 h-16 bg-primary rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20 mb-4 transform -rotate-3 hover:rotate-0 transition-transform duration-300">
                                <Icon name="history_edu" className="text-white text-4xl" />
                            </div>
                            <h1 className="text-2xl font-bold text-[#111418]">เข้าสู่ระบบ</h1>
                            <p className="text-slate-500 text-sm mt-2">เตรียมตัวสอบข้าราชการไปกับเรา</p>
                        </div>
                        <form className="flex flex-col gap-5" onSubmit={handleLogin}>
                            {error && <div className="bg-red-50 text-red-500 text-sm p-3 rounded-xl text-center">{error}</div>}
                            <div className="space-y-1.5">
                                <label className="text-sm font-medium text-slate-700 ml-1">อีเมล</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                                        <Icon name="mail" className="text-slate-400 group-focus-within:text-primary transition-colors" />
                                    </div>
                                    <input type="email" required className="block w-full rounded-2xl border-0 py-3.5 pl-12 text-[#111418] shadow-sm ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary bg-white" placeholder="user@example.com" value={email} onChange={(e) => setEmail(e.target.value)} />
                                </div>
                            </div>
                            <div className="space-y-1.5">
                                <label className="text-sm font-medium text-slate-700 ml-1">รหัสผ่าน</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                                        <Icon name="lock" className="text-slate-400 group-focus-within:text-primary transition-colors" />
                                    </div>
                                    <input type="password" required className="block w-full rounded-2xl border-0 py-3.5 pl-12 pr-12 text-[#111418] shadow-sm ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary bg-white" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} />
                                </div>
                            </div>
                            <button disabled={loading} type="submit" className="w-full rounded-2xl bg-primary px-3.5 py-3.5 text-base font-bold text-white shadow-lg shadow-blue-500/30 hover:bg-blue-600 active:scale-[0.98] transition-all mt-2 disabled:opacity-70 flex justify-center">
                                {loading ? <div className="spinner border-white border-b-transparent h-6 w-6"></div> : 'เข้าสู่ระบบ'}
                            </button>
                        </form>
                        <div className="mt-8 flex flex-col items-center gap-6">
                            <p className="text-center text-sm text-slate-500">
                                ยังไม่มีบัญชีสมาชิก?
                                <button onClick={() => onNavigate('register')} className="font-bold text-primary hover:text-blue-600 transition-colors ml-1">สมัครสมาชิก</button>
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        function RegisterScreen({ onNavigate }) {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    const isDemoAdmin = email.toLowerCase().startsWith('admin');
                    await db.collection('users').doc(user.uid).set({
                        name: name,
                        email: email,
                        role: isDemoAdmin ? 'admin' : 'user',
                        status: isDemoAdmin ? 'active' : 'pending',
                        createdAt: new Date()
                    });
                } catch (err) {
                    console.error(err);
                    setError(err.message || 'เกิดข้อผิดพลาดในการสมัครสมาชิก');
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-white flex flex-col">
                    <div className="flex items-center p-4">
                        <button onClick={() => onNavigate('login')} className="w-10 h-10 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors">
                            <Icon name="arrow_back" className="text-slate-800" />
                        </button>
                    </div>
                    <div className="flex flex-col items-center px-6 pt-2 pb-6">
                        <div className="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mb-4 text-primary">
                            <Icon name="person_add" className="text-4xl" />
                        </div>
                        <h1 className="text-2xl font-bold text-[#111418]">สร้างบัญชีผู้ใช้</h1>
                        <p className="text-slate-500 mt-2 text-center">เริ่มต้นเตรียมสอบข้าราชการไปกับเรา</p>
                    </div>
                    <form className="px-6 pb-6 flex flex-col gap-4 max-w-md mx-auto w-full" onSubmit={handleRegister}>
                        {error && <div className="bg-red-50 text-red-500 text-sm p-3 rounded-xl text-center">{error}</div>}
                        <div className="space-y-1">
                            <label className="text-base font-medium text-[#111418]">ชื่อ-นามสกุล</label>
                            <input required className="w-full h-12 rounded-xl border border-slate-200 px-4 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none" placeholder="สมชาย ใจดี" value={name} onChange={(e) => setName(e.target.value)} />
                        </div>
                        <div className="space-y-1">
                            <label className="text-base font-medium text-[#111418]">อีเมล</label>
                            <input required type="email" className="w-full h-12 rounded-xl border border-slate-200 px-4 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none" placeholder="example@email.com" value={email} onChange={(e) => setEmail(e.target.value)} />
                        </div>
                        <div className="space-y-1">
                            <label className="text-base font-medium text-[#111418]">รหัสผ่าน</label>
                            <input required type="password" className="w-full h-12 rounded-xl border border-slate-200 px-4 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none" placeholder="อย่างน้อย 6 ตัวอักษร" value={password} onChange={(e) => setPassword(e.target.value)} />
                        </div>
                        <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-700 flex items-start gap-2">
                            <Icon name="info" className="text-sm mt-0.5" />
                            <span>สมัครสมาชิกใหม่จะต้องรอการอนุมัติจากผู้ดูแลระบบก่อนเข้าใช้งาน</span>
                        </div>
                        <button disabled={loading} type="submit" className="w-full h-12 bg-primary text-white rounded-xl font-bold text-base shadow-lg shadow-blue-500/20 hover:bg-blue-600 active:scale-[0.98] transition-all flex justify-center items-center">
                            {loading ? <div className="spinner border-white border-b-transparent h-6 w-6"></div> : 'สมัครสมาชิก'}
                        </button>
                    </form>
                </div>
            );
        }

        function PendingApprovalScreen({ onLogout }) {
            return (
                <div className="min-h-screen bg-white flex flex-col items-center justify-center p-6 text-center">
                    <div className="w-24 h-24 bg-orange-50 rounded-full flex items-center justify-center mb-6 text-orange-500">
                        <Icon name="hourglass_empty" className="text-5xl" />
                    </div>
                    <h1 className="text-2xl font-bold text-[#111418] mb-2">รอการอนุมัติ</h1>
                    <p className="text-slate-500 mb-8 max-w-xs">บัญชีของคุณถูกสร้างเรียบร้อยแล้ว<br/>กรุณารอผู้ดูแลระบบตรวจสอบและอนุมัติสิทธิ์การใช้งาน</p>
                    <button onClick={onLogout} className="w-full max-w-xs h-12 rounded-xl border border-slate-200 text-[#111418] font-bold hover:bg-slate-50 transition-colors">
                        กลับสู่หน้าล็อกอิน
                    </button>
                </div>
            );
        }

        function HomeScreen({ user, onNavigate, onStartExam }) {
            const [exams, setExams] = useState([]);
            const [userStats, setUserStats] = useState({ level: 'ผู้เริ่มต้น', score: 0, examsCount: 0 });
            
            useEffect(() => {
                // Fetch Exams
                const unsubscribeExams = db.collection('exams').orderBy('createdAt', 'desc').limit(5).onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setExams(data.length ? data : [INITIAL_MOCK_EXAM]); 
                });

                // Fetch User Stats
                let unsubscribeStats = () => {};
                if (user) {
                    unsubscribeStats = db.collection('exam_results').where('userId', '==', user.uid).onSnapshot(snapshot => {
                        if (snapshot.empty) {
                            setUserStats({ level: 'ผู้เริ่มต้น', score: 0, examsCount: 0 });
                        } else {
                            let totalScore = 0;
                            snapshot.forEach(doc => totalScore += doc.data().score);
                            const avgScore = Math.round(totalScore / snapshot.size);
                            
                            let level = 'ปรับปรุง';
                            if (avgScore >= 90) level = 'ดีเยี่ยม';
                            else if (avgScore >= 80) level = 'ดีมาก';
                            else if (avgScore >= 60) level = 'ดี';
                            
                            setUserStats({ level, score: avgScore, examsCount: snapshot.size });
                        }
                    });
                }

                return () => {
                    unsubscribeExams();
                    unsubscribeStats();
                };
            }, [user]);

            return (
                <div className="pb-24 bg-[#f6f7f8] min-h-screen">
                    <header className="flex items-center justify-between bg-white p-4 sticky top-0 z-10 shadow-sm">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => onNavigate('profile')}>
                             <div className="w-10 h-10 rounded-full bg-slate-200 border-2 border-primary/20 flex items-center justify-center overflow-hidden">
                                <Icon name="person" className="text-slate-500" />
                            </div>
                            <div className="flex flex-col">
                                <span className="text-xs text-slate-500 font-medium">ยินดีต้อนรับกลับ</span>
                                <h2 className="text-lg font-bold leading-tight">สวัสดี, {user?.name || 'ผู้เยี่ยมชม'}!</h2>
                            </div>
                        </div>
                        <button className="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-50 relative transition-colors">
                            <Icon name="notifications" className="text-[#111418]" />
                        </button>
                    </header>
                    <main className="flex flex-col gap-6 px-4 pt-6 max-w-2xl mx-auto w-full">
                        <div className="bg-primary rounded-2xl p-5 shadow-lg shadow-blue-500/20 text-white relative overflow-hidden">
                             <div className="absolute -right-6 -top-6 w-32 h-32 rounded-full bg-white/10 blur-2xl"></div>
                             <div className="relative z-10">
                                <h3 className="text-lg font-bold mb-1">ระดับความสามารถ</h3>
                                <div className="flex items-end gap-4 mb-2">
                                    <span className="text-4xl font-bold">{userStats.level}</span>
                                    <span className="text-sm text-blue-100 mb-1.5">คะแนนเฉลี่ย {userStats.score}%</span>
                                </div>
                                <div className="w-full bg-black/20 rounded-full h-2.5 mb-4 overflow-hidden">
                                    <div className="bg-white h-2.5 rounded-full" style={{ width: `${userStats.score}%` }}></div>
                                </div>
                                <p className="text-xs text-blue-100">จากการทำข้อสอบทั้งหมด {userStats.examsCount} ครั้ง</p>
                             </div>
                        </div>
                        <div className="grid grid-cols-4 gap-4">
                             {[
                                { label: 'เริ่มสอบ', icon: 'play_circle', color: 'bg-blue-50 text-primary', action: () => onNavigate('category') },
                                { label: 'ทบทวน', icon: 'menu_book', color: 'bg-orange-50 text-orange-500', action: () => onNavigate('category') },
                                { label: 'ควิซ', icon: 'quiz', color: 'bg-purple-50 text-purple-500', action: () => {} },
                                { label: 'สรุปเนื้อหา', icon: 'description', color: 'bg-green-50 text-green-600', action: () => onNavigate('summary') }
                            ].map((item, idx) => (
                                <button key={idx} onClick={item.action} className="flex flex-col items-center gap-2 group active:scale-95 transition-transform">
                                    <div className={`w-14 h-14 md:w-16 md:h-16 rounded-2xl flex items-center justify-center ${item.color}`}>
                                        <Icon name={item.icon} className="text-3xl" />
                                    </div>
                                    <span className="text-xs font-medium text-slate-700">{item.label}</span>
                                </button>
                            ))}
                        </div>
                        <div>
                            <div className="flex justify-between items-end mb-4 px-1">
                                <h2 className="text-xl font-bold text-[#111418]">ข้อสอบล่าสุด</h2>
                                <button onClick={() => onNavigate('category')} className="text-sm font-medium text-primary">ดูทั้งหมด</button>
                            </div>
                            <div className="flex overflow-x-auto gap-4 pb-4 -mx-4 px-4 hide-scrollbar snap-x md:grid md:grid-cols-2 md:mx-0 md:px-0">
                                {exams.map((exam, i) => (
                                    <div key={i} className="min-w-[280px] snap-center bg-white rounded-xl overflow-hidden shadow-sm border border-slate-100 flex-shrink-0">
                                        <div className="h-32 bg-slate-200 relative flex items-center justify-center">
                                            <Icon name="history_edu" className="text-slate-300 text-5xl" />
                                        </div>
                                        <div className="p-4">
                                            <h3 className="font-bold text-base mb-1 line-clamp-1">{exam.title}</h3>
                                            <p className="text-xs text-slate-500 mb-4">{exam.questions?.length || 0} ข้อ</p>
                                            <button onClick={() => onStartExam(exam)} className="w-full py-2 bg-primary hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-colors">
                                                เริ่มทำข้อสอบ
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>
                    <BottomNav active="home" onNavigate={onNavigate} />
                </div>
            );
        }

        // --- Reader Modal ---
        function ContentReaderModal({ content, onClose }) {
            return (
                <div className="fixed inset-0 z-50 bg-black bg-opacity-90 flex flex-col">
                    <div className="flex justify-between items-center p-4 bg-black text-white">
                        <h3 className="font-bold truncate pr-4">{content.title}</h3>
                        <button onClick={onClose} className="p-2 bg-white/10 rounded-full hover:bg-white/20">
                            <Icon name="close" />
                        </button>
                    </div>
                    <div className="flex-1 overflow-auto flex items-center justify-center bg-[#111]">
                        {content.type === 'image' && (
                            <img src={content.url} alt={content.title} className="max-w-full max-h-full object-contain" />
                        )}
                        {content.type === 'pdf' && (
                            <iframe src={content.url} className="w-full h-full border-0" title={content.title}></iframe>
                        )}
                        {content.type === 'video' && (
                            <div className="w-full max-w-4xl aspect-video">
                                <iframe 
                                    src={content.url.replace("watch?v=", "embed/")} 
                                    className="w-full h-full border-0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowFullScreen
                                ></iframe>
                            </div>
                        )}
                        {content.type === 'web' && (
                            <iframe src={content.url} className="w-full h-full border-0 bg-white" title={content.title}></iframe>
                        )}
                    </div>
                </div>
            );
        }

        // --- Add Content Modal ---
        function AddContentModal({ onClose, onSave }) {
            const [title, setTitle] = useState('');
            const [url, setUrl] = useState('');
            const [type, setType] = useState('pdf');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!title || !url) return alert('กรุณากรอกข้อมูลให้ครบ');
                onSave({ title, url, type, createdAt: new Date() });
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="bg-white w-full max-w-md mx-4 rounded-xl p-6 shadow-2xl" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg">เพิ่มเนื้อหาสรุป</h3>
                            <button onClick={onClose}><Icon name="close" /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">ชื่อหัวข้อ</label>
                                <input className="w-full border p-2 rounded-lg" value={title} onChange={e => setTitle(e.target.value)} placeholder="เช่น สรุปกฎหมาย ก.พ." />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">ประเภท</label>
                                <select className="w-full border p-2 rounded-lg" value={type} onChange={e => setType(e.target.value)}>
                                    <option value="pdf">ไฟล์ PDF (ลิงก์)</option>
                                    <option value="image">รูปภาพ (ลิงก์)</option>
                                    <option value="video">วิดีโอ YouTube</option>
                                    <option value="web">เว็บไซต์</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">ลิงก์ (URL)</label>
                                <input className="w-full border p-2 rounded-lg" value={url} onChange={e => setUrl(e.target.value)} placeholder="https://..." />
                                <p className="text-xs text-slate-500 mt-1">วางลิงก์ไฟล์ PDF, รูปภาพ, หรือวิดีโอที่ต้องการแสดง</p>
                            </div>
                            <button type="submit" className="w-full bg-primary text-white py-2 rounded-lg font-bold mt-4">บันทึก</button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Summary Screen ---
        function SummaryScreen({ user, onNavigate }) {
            const [summaries, setSummaries] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showAddModal, setShowAddModal] = useState(false);
            const [viewingContent, setViewingContent] = useState(null);

            useEffect(() => {
                const unsubscribe = db.collection('summaries').orderBy('createdAt', 'desc').limit(20).onSnapshot(snapshot => {
                    setSummaries(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleSaveContent = async (data) => {
                try {
                    await db.collection('summaries').add(data);
                    setShowAddModal(false);
                } catch (error) {
                    alert('เกิดข้อผิดพลาดในการบันทึก');
                }
            };

            const handleDelete = async (id) => {
                if (confirm('ต้องการลบเนื้อหานี้?')) {
                    await db.collection('summaries').doc(id).delete();
                }
            };

            return (
                <div className="flex flex-col min-h-screen bg-[#f6f7f8] pb-24">
                    <div className="sticky top-0 z-20 flex items-center justify-between bg-white p-4 border-b border-slate-100 shadow-sm">
                        <div className="flex items-center gap-2">
                            <button onClick={() => onNavigate('home')}><Icon name="arrow_back" className="text-[#111418]" /></button>
                            <h2 className="text-lg font-bold text-[#111418]">สรุปเนื้อหา</h2>
                        </div>
                        {user.role === 'admin' && (
                            <button onClick={() => setShowAddModal(true)} className="bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 shadow-sm hover:bg-green-700">
                                <Icon name="add" className="text-base" /> เพิ่มเนื้อหา
                            </button>
                        )}
                    </div>

                    <div className="p-4 max-w-4xl mx-auto w-full">
                        {loading ? <LoadingSpinner /> : summaries.length === 0 ? (
                            <div className="text-center py-10 text-slate-500">
                                <Icon name="folder_open" className="text-4xl mb-2" />
                                <p>ยังไม่มีเอกสารสรุป</p>
                            </div>
                        ) : (
                            <div className="flex flex-col gap-3">
                                {summaries.map((item) => (
                                    <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow flex items-center justify-between cursor-pointer" onClick={() => setViewingContent(item)}>
                                        <div className="flex items-center gap-4 overflow-hidden">
                                            <div className={`w-12 h-12 rounded-lg flex items-center justify-center shrink-0 ${item.type === 'pdf' ? 'bg-red-50 text-red-500' : item.type === 'video' ? 'bg-red-50 text-red-600' : 'bg-blue-50 text-blue-500'}`}>
                                                <Icon name={item.type === 'pdf' ? 'picture_as_pdf' : item.type === 'video' ? 'play_circle' : item.type === 'image' ? 'image' : 'language'} />
                                            </div>
                                            <div className="min-w-0">
                                                <h4 className="font-bold text-[#111418] truncate pr-2">{item.title}</h4>
                                                <p className="text-xs text-slate-500 flex items-center gap-1">
                                                    {item.createdAt?.toDate ? item.createdAt.toDate().toLocaleDateString('th-TH') : 'N/A'} • 
                                                    <span className="uppercase">{item.type}</span>
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <Icon name="visibility" className="text-slate-300" />
                                            {user.role === 'admin' && (
                                                <button onClick={(e) => { e.stopPropagation(); handleDelete(item.id); }} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors">
                                                    <Icon name="delete" />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    {showAddModal && <AddContentModal onClose={() => setShowAddModal(false)} onSave={handleSaveContent} />}
                    {viewingContent && <ContentReaderModal content={viewingContent} onClose={() => setViewingContent(null)} />}
                    
                    <BottomNav active="summary" onNavigate={onNavigate} />
                </div>
            );
        }

        function CategoryScreen({ onNavigate, onStartExam }) {
            const [exams, setExams] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = db.collection('exams').orderBy('createdAt', 'desc').limit(20).onSnapshot(snapshot => {
                    setExams(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            return (
                <div className="flex flex-col min-h-screen bg-[#f6f7f8]">
                    <div className="sticky top-0 z-20 flex items-center bg-white/90 backdrop-blur-md p-4 border-b border-slate-100">
                        <button onClick={() => onNavigate('home')} className="mr-3">
                            <Icon name="arrow_back" className="text-[#111418]" />
                        </button>
                        <h2 className="text-lg font-bold text-[#111418]">เลือกข้อสอบ</h2>
                    </div>
                    <div className="p-4 max-w-4xl mx-auto w-full">
                        {loading ? <LoadingSpinner /> : exams.length === 0 ? (
                            <div className="text-center py-10 text-slate-500">
                                <Icon name="sentiment_dissatisfied" className="text-4xl mb-2" />
                                <p>ยังไม่มีข้อสอบในระบบ</p>
                            </div>
                        ) : (
                            <div className="flex flex-col gap-3">
                                {exams.map((exam) => (
                                    <div key={exam.id} onClick={() => onStartExam(exam)} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow cursor-pointer flex items-center justify-between">
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 rounded-lg bg-blue-50 flex items-center justify-center text-primary">
                                                <Icon name="description" />
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-[#111418] mb-1">{exam.title}</h4>
                                                <p className="text-xs text-slate-500">{exam.questions?.length || 0} ข้อ • {Math.floor((exam.timeLimit || 1800) / 60)} นาที</p>
                                            </div>
                                        </div>
                                        <Icon name="chevron_right" className="text-slate-400" />
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <BottomNav active="category" onNavigate={onNavigate} />
                </div>
            );
        }

        function HistoryScreen({ user, onNavigate }) {
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user) return;
                const fetchHistory = async () => {
                    try {
                        const snapshot = await db.collection('exam_results')
                            .where('userId', '==', user.uid)
                            .orderBy('date', 'desc')
                            .get();
                        const data = snapshot.docs.map(doc => {
                            const d = doc.data();
                            return { id: doc.id, ...d, dateString: d.date && d.date.toDate ? d.date.toDate().toLocaleDateString('th-TH') : 'N/A' };
                        });
                        setHistory(data);
                    } catch (error) { console.error(error); } finally { setLoading(false); }
                };
                fetchHistory();
            }, [user]);

            return (
                <div className="min-h-screen bg-[#f6f7f8] pb-24">
                    <div className="sticky top-0 z-20 flex items-center justify-between bg-white p-4 border-b border-slate-100 shadow-sm">
                        <button onClick={() => onNavigate('home')}><Icon name="arrow_back" className="text-[#111418]" /></button>
                        <h1 className="text-lg font-bold">ประวัติการสอบ</h1>
                        <div className="w-8"></div>
                    </div>
                    {loading ? <LoadingSpinner /> : (
                        <div className="px-4 py-4 flex flex-col gap-3">
                            {history.length === 0 ? <div className="text-center text-slate-500 mt-10">ยังไม่มีประวัติการสอบ</div> : history.map((item) => (
                                <div key={item.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col gap-3">
                                    <div className="flex justify-between items-start">
                                        <div className="flex gap-3">
                                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${item.status === 'pass' ? 'bg-blue-50 text-primary' : 'bg-red-50 text-red-500'}`}><Icon name="description" /></div>
                                            <div><h4 className="font-bold text-[#111418] text-sm">{item.examTitle}</h4><p className="text-xs text-slate-500">วันที่ {item.dateString}</p></div>
                                        </div>
                                        <span className={`px-2 py-1 rounded-lg text-xs font-bold ${item.status === 'pass' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{item.score}%</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    <BottomNav active="history" onNavigate={onNavigate} />
                </div>
            );
        }

        function ProfileScreen({ user, onNavigate, onLogout }) {
            return (
                <div className="min-h-screen bg-[#f6f7f8] pb-24">
                    <div className="bg-white pb-4">
                        <div className="flex items-center justify-between p-4">
                            <button onClick={() => onNavigate('home')}><Icon name="arrow_back" className="text-[#111418]" /></button>
                            <h2 className="text-lg font-bold">โปรไฟล์</h2>
                            <div className="w-6"></div>
                        </div>
                        <div className="flex flex-col items-center gap-3">
                            <div className="w-24 h-24 rounded-full bg-slate-200 relative border-4 border-white shadow-md flex items-center justify-center">
                                <span className="text-4xl text-slate-400 font-bold">{user?.name ? user.name.charAt(0) : 'U'}</span>
                            </div>
                            <div className="text-center">
                                <h3 className="text-xl font-bold text-[#111418]">{user?.name || 'User'}</h3>
                                <p className="text-sm text-slate-500">{user?.email}</p>
                            </div>
                        </div>
                    </div>
                    <div className="mt-4 px-4">
                        <button onClick={onLogout} className="w-full py-3 text-red-600 font-bold bg-white rounded-xl shadow-sm border border-slate-200 hover:bg-red-50 transition-colors">ออกจากระบบ</button>
                    </div>
                    <BottomNav active="profile" onNavigate={onNavigate} />
                </div>
            );
        }

        function ExamScreen({ examData, examState, onAnswer, onNext, onSubmit, onNavigate }) {
            const currentQ = examData.questions[examState.currentQuestionIndex];
            const hasAnswered = !!examState.answers[currentQ.id];
            const cleanCorrect = normalizeAnswer(currentQ.correct);
            const cleanAnswer = hasAnswered ? normalizeAnswer(examState.answers[currentQ.id]) : '';
            const isCorrect = hasAnswered && cleanAnswer === cleanCorrect;
            
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            useEffect(() => {
                if (hasAnswered) {
                    const feedbackEl = document.getElementById('feedback-section');
                    if (feedbackEl) feedbackEl.scrollIntoView({ behavior: 'smooth' });
                }
            }, [hasAnswered]);

            return (
                <div className="flex flex-col h-screen bg-white">
                    <header className="flex-none flex items-center justify-between p-4 border-b border-slate-100">
                        <button onClick={() => onNavigate('home')}><Icon name="close" className="text-slate-800" /></button>
                        <h2 className="font-bold text-lg text-[#111418] truncate pr-2 max-w-[200px]">{examData.title}</h2>
                        <div className="w-6"></div>
                    </header>
                    <div className="flex-none px-4 py-3 bg-white shadow-sm z-10">
                        <div className="flex justify-between items-center mb-2 max-w-2xl mx-auto w-full">
                            <div className="flex items-center gap-2 text-primary">
                                <Icon name="timer" className="text-xl" />
                                <span className="text-lg font-bold tabular-nums">{formatTime(examState.timeRemaining)}</span>
                            </div>
                            <span className="text-xs text-slate-500 font-medium">ข้อที่ {examState.currentQuestionIndex + 1}/{examData.questions.length}</span>
                        </div>
                         <div className="max-w-2xl mx-auto w-full">
                            <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                <div className="bg-primary h-full transition-all duration-300" style={{ width: `${((examState.currentQuestionIndex + 1) / examData.questions.length) * 100}%` }}></div>
                            </div>
                        </div>
                    </div>
                    <main className="flex-1 overflow-y-auto p-4 pb-20">
                        <div className="flex flex-col gap-4 max-w-2xl mx-auto w-full">
                            <h2 className="text-xl font-bold text-[#111418] leading-snug">{currentQ.question}</h2>
                            <div className="flex flex-col gap-3">
                                {currentQ.options.map((opt) => {
                                    const isSelected = examState.answers[currentQ.id] === opt.id;
                                    const cleanOptId = normalizeAnswer(opt.id);
                                    const isCorrectOption = cleanCorrect === cleanOptId;
                                    
                                    let containerClass = "border-slate-200 hover:border-primary/50";
                                    let iconClass = "border-slate-300";
                                    
                                    if (hasAnswered) {
                                        if (isCorrectOption) {
                                            containerClass = "border-green-500 bg-green-50";
                                            iconClass = "border-green-500 bg-green-500 text-white";
                                        } else if (isSelected) {
                                            containerClass = "border-red-500 bg-red-50";
                                            iconClass = "border-red-500 bg-red-500 text-white";
                                        } else {
                                            containerClass = "border-slate-200 opacity-60";
                                        }
                                    } else if (isSelected) {
                                        containerClass = "border-primary bg-primary/5";
                                        iconClass = "border-primary bg-primary";
                                    }

                                    return (
                                        <label key={opt.id} className={`flex items-center gap-4 p-4 rounded-xl border cursor-pointer transition-all ${containerClass}`}>
                                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center shrink-0 ${iconClass}`}>
                                                {hasAnswered && isCorrectOption && <Icon name="check" className="text-sm font-bold text-white" />}
                                                {hasAnswered && isSelected && !isCorrectOption && <Icon name="close" className="text-sm font-bold text-white" />}
                                                {!hasAnswered && isSelected && <div className="w-2.5 h-2.5 rounded-full bg-primary" />}
                                            </div>
                                            <input type="radio" name={`q-${currentQ.id}`} className="hidden" onChange={() => onAnswer(currentQ.id, opt.id)} checked={isSelected} disabled={hasAnswered} />
                                            <span className={`text-base font-medium ${hasAnswered && isCorrectOption ? 'text-green-700 font-bold' : hasAnswered && isSelected ? 'text-red-700' : 'text-[#111418]'}`}>{opt.text}</span>
                                        </label>
                                    );
                                })}
                            </div>
                            {hasAnswered && (
                                <div id="feedback-section" className={`mt-4 p-4 rounded-xl border ${isCorrect ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'} animate-fade-in`}>
                                    <div className="flex items-center gap-2 mb-2">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center ${isCorrect ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                            <Icon name={isCorrect ? "check" : "close"} />
                                        </div>
                                        <h3 className={`font-bold text-lg ${isCorrect ? 'text-green-700' : 'text-red-700'}`}>{isCorrect ? "ถูกต้อง!" : "ยังไม่ถูกนะ"}</h3>
                                    </div>
                                    <p className="text-[#111418] text-sm leading-relaxed"><span className="font-bold">คำอธิบาย:</span> {currentQ.explanation || "ไม่มีคำอธิบายเพิ่มเติม"}</p>
                                </div>
                            )}
                        </div>
                    </main>
                    <footer className="flex-none p-4 border-t border-slate-100 bg-white pb-safe">
                        <div className="max-w-2xl mx-auto w-full">
                            {hasAnswered ? (
                                <button onClick={onNext} className="w-full h-12 rounded-xl bg-primary text-white font-bold hover:bg-blue-600 shadow-lg flex items-center justify-center gap-2 animate-bounce-short">
                                    {examState.currentQuestionIndex === examData.questions.length - 1 ? 'ดูผลสอบ' : 'ข้อถัดไป'} <Icon name="arrow_forward" />
                                </button>
                            ) : (
                                <div className="text-center text-slate-400 text-sm">เลือกคำตอบเพื่อตรวจสอบ</div>
                            )}
                        </div>
                    </footer>
                </div>
            );
        }

        function ResultScreen({ examState, totalQuestions, onNavigate }) {
            const isPass = examState.score >= 60;
            return (
                <div className="flex flex-col min-h-screen bg-white">
                     <div className="flex items-center p-4 border-b border-slate-100">
                        <button onClick={() => onNavigate('home')} className="mr-auto"><Icon name="close" className="text-[#111418]" /></button>
                        <h2 className="text-lg font-bold flex-1 text-center pr-6">ผลการสอบ</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 flex flex-col items-center">
                         <div className="relative w-48 h-48 flex items-center justify-center mb-6">
                            <div className="flex flex-col items-center">
                                <span className="text-slate-500 text-sm font-medium">คะแนนรวม</span>
                                <span className="text-5xl font-bold text-[#111418]">{examState.score}</span>
                                <span className="text-sm text-slate-400">/ 100</span>
                            </div>
                        </div>
                        <h2 className="text-2xl font-bold text-[#111418] mb-2">{isPass ? 'ยินดีด้วย!' : 'พยายามใหม่นะ'}</h2>
                        <p className="text-slate-500 mb-8">{isPass ? 'คุณผ่านเกณฑ์การทดสอบ' : 'คุณยังไม่ผ่านเกณฑ์ 60%'}</p>
                        <button onClick={() => onNavigate('home')} className="w-full max-w-xs h-12 flex items-center justify-center rounded-xl bg-primary text-white font-bold hover:bg-blue-600">กลับหน้าหลัก</button>
                    </div>
                </div>
            )
        }

        function QuestionEditorModal({ question, onClose, onSave }) {
            const [data, setData] = useState(question ? {...question} : {
                question: '',
                options: [{id:'A', text:''}, {id:'B', text:''}, {id:'C', text:''}, {id:'D', text:''}],
                correct: 'A',
                explanation: ''
            });

            const handleOptionChange = (idx, val) => {
                const newOpts = [...data.options];
                newOpts[idx].text = val;
                setData({...data, options: newOpts});
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="bg-white w-full max-w-lg mx-4 rounded-xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg">{question ? 'แก้ไขข้อสอบ' : 'เพิ่มข้อสอบใหม่'}</h3>
                            <button onClick={onClose}><Icon name="close" /></button>
                        </div>
                        <div className="space-y-3">
                            <div>
                                <label className="text-sm font-medium">โจทย์</label>
                                <textarea className="w-full border p-2 rounded-lg" rows="3" value={data.question} onChange={e => setData({...data, question: e.target.value})}></textarea>
                            </div>
                            <div>
                                <label className="text-sm font-medium">ตัวเลือก</label>
                                {data.options.map((opt, i) => (
                                    <div key={i} className="flex gap-2 items-center mt-1">
                                        <span className="w-6 text-center font-bold">{opt.id}</span>
                                        <input className="flex-1 border p-2 rounded-lg" value={opt.text} onChange={e => handleOptionChange(i, e.target.value)} />
                                        <input type="radio" name="correct" checked={data.correct === opt.id} onChange={() => setData({...data, correct: opt.id})} className="w-4 h-4" />
                                    </div>
                                ))}
                            </div>
                            <div>
                                <label className="text-sm font-medium">คำอธิบายเฉลย</label>
                                <textarea className="w-full border p-2 rounded-lg" rows="2" value={data.explanation} onChange={e => setData({...data, explanation: e.target.value})}></textarea>
                            </div>
                        </div>
                        <div className="mt-6 flex gap-2">
                            <button onClick={() => onSave(data)} className="flex-1 bg-primary text-white py-2 rounded-lg font-bold">บันทึก</button>
                            <button onClick={onClose} className="flex-1 bg-slate-100 text-slate-600 py-2 rounded-lg font-bold">ยกเลิก</button>
                        </div>
                    </div>
                </div>
            );
        }

        function AdminExamScreen({ onNavigate }) {
            const [viewMode, setViewMode] = useState('list');
            const [exams, setExams] = useState([]);
            const [editorData, setEditorData] = useState({ id: null, title: '', questions: [] });
            const [isUploading, setIsUploading] = useState(false);
            const [editingQuestionIndex, setEditingQuestionIndex] = useState(null);
            const [showQuestionModal, setShowQuestionModal] = useState(false);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = db.collection('exams').orderBy('createdAt', 'desc').limit(20).onSnapshot(snapshot => {
                    setExams(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleDeleteExam = async (id) => {
                if(confirm('คุณต้องการลบชุดข้อสอบนี้ใช่หรือไม่?')) {
                    try { await db.collection('exams').doc(id).delete(); } catch (e) { alert('เกิดข้อผิดพลาดในการลบ'); }
                }
            };

            const handleEditExam = (exam) => { setEditorData({ ...exam }); setViewMode('editor'); };
            const handleCreateExam = () => { setEditorData({ id: null, title: 'ชุดข้อสอบใหม่', questions: [] }); setViewMode('editor'); };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setIsUploading(true);
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const newQuestions = [];
                    for (let line of lines) {
                        line = line.trim();
                        if (!line) continue;
                        const matches = line.match(/^"(.+)","(.+)","(.+)","(.+)","(.+)","(.+)","(.+)"$/);
                        if (matches && matches.length === 8) { 
                            newQuestions.push({
                                question: matches[1],
                                options: [
                                    { id: 'A', text: matches[2] },
                                    { id: 'B', text: matches[3] },
                                    { id: 'C', text: matches[4] },
                                    { id: 'D', text: matches[5] }
                                ],
                                correct: normalizeAnswer(matches[6]), 
                                explanation: matches[7],
                                id: Date.now() + Math.random()
                            });
                        }
                    }
                    setEditorData({ id: null, title: `ชุดข้อสอบนำเข้า ${new Date().toLocaleString('th-TH')}`, questions: newQuestions });
                    setViewMode('editor');
                    setIsUploading(false);
                    event.target.value = null;
                };
                reader.readAsText(file);
            };

            const saveExamToFirestore = async () => {
                try {
                    const dataToSave = {
                        title: editorData.title,
                        questions: editorData.questions,
                        timeLimit: editorData.questions.length * 60,
                        subject: "ทั่วไป",
                        createdAt: editorData.createdAt || new Date()
                    };
                    if (editorData.id) await db.collection('exams').doc(editorData.id).update(dataToSave);
                    else await db.collection('exams').add(dataToSave);
                    alert('บันทึกสำเร็จ');
                    setViewMode('list');
                } catch (e) { console.error(e); alert('บันทึกไม่สำเร็จ'); }
            };

            const handleSaveQuestion = (qData) => {
                const normalizedQData = { ...qData, correct: normalizeAnswer(qData.correct) };
                const newQuestions = [...editorData.questions];
                if (editingQuestionIndex !== null) newQuestions[editingQuestionIndex] = normalizedQData;
                else newQuestions.push({ ...normalizedQData, id: Date.now() + Math.random() });
                setEditorData({ ...editorData, questions: newQuestions });
                setShowQuestionModal(false);
            };

            const handleDeleteQuestion = (idx) => {
                if (confirm('ลบข้อนี้?')) {
                    const newQuestions = editorData.questions.filter((_, i) => i !== idx);
                    setEditorData({ ...editorData, questions: newQuestions });
                }
            };

            if (viewMode === 'list') {
                return (
                    <div className="pb-24 bg-[#f6f7f8] min-h-screen">
                        <div className="sticky top-0 z-20 flex items-center justify-between bg-white p-4 border-b border-slate-100 shadow-sm">
                            <h2 className="text-lg font-bold text-[#111418]">จัดการข้อสอบ</h2>
                            <div className="flex gap-2">
                                <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" id="csv-upload" disabled={isUploading} />
                                <label htmlFor="csv-upload" className={`bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 cursor-pointer hover:bg-green-700 transition-colors ${isUploading ? 'opacity-50' : ''}`}>
                                    {isUploading ? '...' : <Icon name="upload_file" className="text-base" />} CSV
                                </label>
                                <button onClick={handleCreateExam} className="bg-admin-primary text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1">
                                    <Icon name="add" className="text-base" /> สร้าง
                                </button>
                            </div>
                        </div>
                        <div className="p-4 max-w-4xl mx-auto w-full flex flex-col gap-3">
                            {loading ? <LoadingSpinner /> : exams.length === 0 ? <div className="text-center py-10 text-slate-400">ยังไม่มีข้อสอบ</div> : exams.map(exam => (
                                <div key={exam.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                    <div className="flex gap-3">
                                        <div className="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center text-blue-600 shrink-0"><Icon name="description" /></div>
                                        <div><h4 className="font-bold text-[#111418]">{exam.title}</h4><p className="text-xs text-slate-500">{exam.questions?.length || 0} ข้อ • {exam.createdAt?.toDate ? exam.createdAt.toDate().toLocaleDateString('th-TH') : 'N/A'}</p></div>
                                    </div>
                                    <div className="flex gap-2 self-end sm:self-center">
                                        <button onClick={() => handleEditExam(exam)} className="p-2 text-slate-400 hover:text-admin-primary bg-slate-50 rounded-lg"><Icon name="edit" /></button>
                                        <button onClick={() => handleDeleteExam(exam.id)} className="p-2 text-slate-400 hover:text-red-500 bg-slate-50 rounded-lg"><Icon name="delete" /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <AdminBottomNav active="admin-exams" onNavigate={onNavigate} />
                    </div>
                );
            }

            return (
                <div className="bg-[#f6f7f8] min-h-screen flex flex-col">
                    <div className="sticky top-0 z-20 bg-white p-4 border-b border-slate-100 shadow-sm flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <button onClick={() => setViewMode('list')}><Icon name="arrow_back" /></button>
                            <h2 className="text-lg font-bold">แก้ไขข้อสอบ</h2>
                        </div>
                        <button onClick={saveExamToFirestore} className="bg-primary text-white px-4 py-1.5 rounded-lg font-bold shadow-lg shadow-blue-500/30">บันทึกชุดข้อสอบ</button>
                    </div>
                    <div className="p-4 max-w-4xl mx-auto w-full flex-1 overflow-y-auto pb-24">
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-4">
                            <label className="text-sm font-bold text-slate-500">ชื่อชุดข้อสอบ</label>
                            <input className="w-full text-lg font-bold border-b border-slate-200 py-2 focus:border-primary outline-none bg-transparent" value={editorData.title} onChange={e => setEditorData({...editorData, title: e.target.value})} placeholder="ตั้งชื่อชุดข้อสอบ..." />
                        </div>
                        <div className="flex items-center justify-between mb-2 px-1">
                            <h3 className="font-bold text-slate-700">รายการข้อสอบ ({editorData.questions.length})</h3>
                            <button onClick={() => { setEditingQuestionIndex(null); setShowQuestionModal(true); }} className="text-primary text-sm font-bold flex items-center gap-1"> <Icon name="add_circle" /> เพิ่มข้อ </button>
                        </div>
                        <div className="space-y-3">
                            {editorData.questions.map((q, idx) => (
                                <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                                    <div className="flex justify-between items-start gap-4">
                                        <div className="flex-1">
                                            <div className="flex gap-2"><span className="font-bold text-slate-400">{idx + 1}.</span><p className="font-medium text-[#111418]">{q.question}</p></div>
                                            <p className="text-xs text-green-600 mt-1 ml-6">เฉลย: {q.correct}</p>
                                        </div>
                                        <div className="flex gap-1 shrink-0">
                                            <button onClick={() => { setEditingQuestionIndex(idx); setShowQuestionModal(true); }} className="p-1.5 text-slate-400 hover:text-admin-primary bg-slate-50 rounded"><Icon name="edit" className="text-sm" /></button>
                                            <button onClick={() => handleDeleteQuestion(idx)} className="p-1.5 text-slate-400 hover:text-red-500 bg-slate-50 rounded"><Icon name="delete" className="text-sm" /></button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    {showQuestionModal && (
                        <QuestionEditorModal question={editingQuestionIndex !== null ? editorData.questions[editingQuestionIndex] : null} onClose={() => setShowQuestionModal(false)} onSave={handleSaveQuestion} />
                    )}
                </div>
            );
        }

        function AdminHomeScreen({ user, onNavigate, onLogout }) {
             const ADMIN_STATS = [
                { title: "ผู้ใช้งานทั้งหมด", value: "...", icon: "group", color: "bg-blue-500" },
                { title: "ข้อสอบในระบบ", value: "...", icon: "library_books", color: "bg-green-500" },
            ];
            return (
                <div className="pb-24 bg-[#f6f7f8] min-h-screen">
                    <header className="flex items-center justify-between bg-white p-4 sticky top-0 z-10 shadow-sm border-b border-purple-100">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-admin-primary text-white flex items-center justify-center"><Icon name="admin_panel_settings" /></div>
                            <div className="flex flex-col"><span className="text-xs text-slate-500 font-medium">Administrator</span><h2 className="text-lg font-bold leading-tight text-admin-primary">{user?.name}</h2></div>
                        </div>
                        <button onClick={onLogout} className="p-2 text-slate-400 hover:text-red-500"><Icon name="logout" /></button>
                    </header>
                    <main className="flex flex-col gap-6 px-4 pt-6 max-w-4xl mx-auto w-full">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {ADMIN_STATS.map((stat, idx) => (
                                <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col gap-2">
                                    <div className={`w-10 h-10 rounded-lg ${stat.color} bg-opacity-10 flex items-center justify-center`}><Icon name={stat.icon} className={`text-${stat.color.split('-')[1]}-600`} /></div>
                                    <div><p className="text-slate-500 text-xs">{stat.title}</p><p className="text-xl font-bold text-[#111418]">{stat.value}</p></div>
                                </div>
                            ))}
                        </div>
                    </main>
                    <AdminBottomNav active="admin-home" onNavigate={onNavigate} />
                </div>
            );
        }

        function AdminUserScreen({ onNavigate, currentUser }) {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [tab, setTab] = useState('pending');

            useEffect(() => {
                const unsubscribe = db.collection('users').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    setUsers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const approveUser = async (userId) => {
                try { await db.collection('users').doc(userId).update({ status: 'active' }); } catch (error) { alert("เกิดข้อผิดพลาดในการอนุมัติ"); }
            };

            const deleteUser = async (userId) => {
                if (confirm('คุณต้องการลบผู้ใช้นี้ออกจากระบบใช่หรือไม่?')) {
                    try { await db.collection('users').doc(userId).delete(); } catch (error) { alert("เกิดข้อผิดพลาดในการลบ"); }
                }
            };

            const filteredUsers = tab === 'pending' ? users.filter(u => u.status === 'pending') : users;

            return (
                <div className="pb-24 bg-[#f6f7f8] min-h-screen">
                    <div className="sticky top-0 z-20 flex flex-col bg-white border-b border-slate-100 shadow-sm">
                        <div className="flex items-center justify-between p-4">
                            <h2 className="text-lg font-bold text-[#111418]">จัดการผู้ใช้</h2>
                            <div className="w-8"></div>
                        </div>
                        <div className="flex px-4 pb-2 gap-4">
                            <button onClick={() => setTab('pending')} className={`pb-2 text-sm font-bold border-b-2 transition-colors ${tab === 'pending' ? 'border-primary text-primary' : 'border-transparent text-slate-400'}`}> รออนุมัติ ({users.filter(u => u.status === 'pending').length}) </button>
                            <button onClick={() => setTab('all')} className={`pb-2 text-sm font-bold border-b-2 transition-colors ${tab === 'all' ? 'border-primary text-primary' : 'border-transparent text-slate-400'}`}> ทั้งหมด </button>
                        </div>
                    </div>
                    <div className="p-4 max-w-4xl mx-auto w-full">
                        {loading ? <LoadingSpinner /> : (
                            <div className="flex flex-col gap-3">
                                {filteredUsers.length === 0 && ( <div className="text-center py-10 text-slate-400"> <p>ไม่มีรายชื่อผู้ใช้</p> </div> )}
                                {filteredUsers.map(user => (
                                    <div key={user.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                        <div className="flex gap-3 items-center">
                                            <div className={`w-12 h-12 rounded-full flex items-center justify-center shrink-0 ${user.status === 'pending' ? 'bg-orange-100 text-orange-600' : 'bg-slate-100 text-slate-500'}`}> <span className="text-lg font-bold">{user.name ? user.name.charAt(0).toUpperCase() : 'U'}</span> </div>
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <h4 className="font-bold text-[#111418]">{user.name || 'User'}</h4>
                                                    {user.status === 'pending' && <span className="bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded-full font-bold">รออนุมัติ</span>}
                                                    {user.role === 'admin' && <span className="bg-purple-100 text-purple-700 text-[10px] px-2 py-0.5 rounded-full font-bold">Admin</span>}
                                                </div>
                                                <p className="text-xs text-slate-500">{user.email}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 self-end sm:self-center">
                                            {user.status === 'pending' && ( <button onClick={() => approveUser(user.id)} className="bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm hover:bg-green-700 flex items-center gap-1"> <Icon name="check" className="text-base" /> อนุมัติ </button> )}
                                            <button onClick={() => deleteUser(user.id)} disabled={currentUser && currentUser.uid === user.id} className={`p-2 rounded-lg text-slate-400 transition-colors ${currentUser && currentUser.uid === user.id ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-50 hover:text-red-500'}`} > <Icon name="delete" /> </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    <AdminBottomNav active="admin-users" onNavigate={onNavigate} />
                </div>
            );
        }

        function BottomNav({ active, onNavigate }) {
            const navItems = [{ id: 'home', icon: 'home', label: 'หน้าหลัก' }, { id: 'category', icon: 'menu_book', label: 'วิชาสอบ' }, { id: 'history', icon: 'bar_chart', label: 'ประวัติ' }, { id: 'profile', icon: 'person', label: 'โปรไฟล์' }];
            return <div className="fixed bottom-0 w-full bg-white border-t border-slate-100 px-6 py-2 flex justify-between items-center z-50 pb-safe max-w-[inherit] left-auto right-auto">{navItems.map((item) => (<button key={item.id} onClick={() => onNavigate(item.id)} className={`flex flex-col items-center gap-1 p-2 transition-colors ${active === item.id ? 'text-primary' : 'text-slate-400'}`}><Icon name={item.icon} className={active === item.id ? 'fill-current' : ''} style={{ fontVariationSettings: active === item.id ? "'FILL' 1" : "'FILL' 0" }} /><span className="text-[10px] font-medium">{item.label}</span></button>))}</div>;
        }

        function AdminBottomNav({ active, onNavigate }) {
            const navItems = [{ id: 'admin-home', icon: 'dashboard', label: 'ภาพรวม' }, { id: 'admin-exams', icon: 'library_books', label: 'ข้อสอบ' }, { id: 'admin-users', icon: 'group', label: 'ผู้ใช้' }, { id: 'home', icon: 'visibility', label: 'ดูหน้าเว็บ' }];
            return <div className="fixed bottom-0 w-full bg-white border-t border-purple-100 px-6 py-2 flex justify-between items-center z-50 pb-safe max-w-[inherit] left-auto right-auto">{navItems.map((item) => (<button key={item.id} onClick={() => onNavigate(item.id)} className={`flex flex-col items-center gap-1 p-2 transition-colors ${active === item.id ? 'text-admin-primary' : 'text-slate-400'}`}><Icon name={item.icon} /><span className="text-[10px] font-medium">{item.label}</span></button>))}</div>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
