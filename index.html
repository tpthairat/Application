<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Civil Service Exam Prep (Firebase Connected)</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material Symbols (Icons) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "admin-primary": "#7c3aed",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "Noto Sans Thai", "sans-serif"],
                        "body": ["Public Sans", "Noto Sans Thai", "sans-serif"],
                    },
                    screens: {
                        'xs': '375px',
                        'sm': '640px',
                        'md': '768px',
                        'lg': '1024px',
                        'xl': '1280px',
                    },
                },
            },
        }
    </script>

    <!-- React & ReactDOM & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK (Compat version for simple HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Public Sans', 'Noto Sans Thai', sans-serif; background-color: #f3f4f6; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #app-container {
            max-width: 100%;
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        
        @media (min-width: 768px) {
            #app-container {
                max-width: 768px;
            }
        }
        
        @media (min-width: 1024px) {
            body {
                padding: 0;
                display: flex;
                justify-content: center;
            }
             #app-container {
                max-width: 600px;
                min-height: 100vh;
                border-left: 1px solid #e5e7eb;
                border-right: 1px solid #e5e7eb;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #137fec;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">
    <div id="root" class="w-full"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDaSXAda-YiHCgsCJzQA_bnPLZKOoOy0Ek",
            authDomain: "application-b08ac.firebaseapp.com",
            databaseURL: "https://application-b08ac-default-rtdb.firebaseio.com",
            projectId: "application-b08ac",
            storageBucket: "application-b08ac.firebasestorage.app",
            messagingSenderId: "303359329226",
            appId: "1:303359329226:web:ca24a7031e2418f5148533",
            measurementId: "G-J469TY8LN1"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Mock Exam Data ---
        const MOCK_EXAM_DATA = {
            title: "แนวข้อสอบ ก.พ. ภาค ก.",
            subject: "วิชากฎหมายและระเบียบข้าราชการ",
            timeLimit: 30 * 60,
            questions: [
                {
                    id: 1,
                    question: "ข้อใดต่อไปนี้ ไม่ใช่ หลักธรรมาภิบาลของการบริหารกิจการบ้านเมืองที่ดี?",
                    options: [
                        { id: 'A', text: "ก. หลักนิติธรรม" },
                        { id: 'B', text: "ข. หลักคุณธรรม" },
                        { id: 'C', text: "ค. หลักความลับ" },
                        { id: 'D', text: "ง. หลักความโปร่งใส" }
                    ],
                    correct: 'C'
                },
                {
                    id: 2,
                    question: "บุคคลใดเป็นผู้รักษาการตามพระราชบัญญัติระเบียบบริหารราชการแผ่นดิน?",
                    options: [
                        { id: 'A', text: "ก. นายกรัฐมนตรี" },
                        { id: 'B', text: "ข. รัฐมนตรีว่าการกระทรวงมหาดไทย" },
                        { id: 'C', text: "ค. ประธานรัฐสภา" },
                        { id: 'D', text: "ง. ปลัดสำนักนายกรัฐมนตรี" }
                    ],
                    correct: 'A'
                },
                {
                    id: 3,
                    question: "การแบ่งส่วนราชการภายในกรม จะต้องตราเป็นกฎหมายใด?",
                    options: [
                        { id: 'A', text: "ก. พระราชบัญญัติ" },
                        { id: 'B', text: "ข. พระราชกฤษฎีกา" },
                        { id: 'C', text: "ค. กฎกระทรวง" },
                        { id: 'D', text: "ง. ประกาศกระทรวง" }
                    ],
                    correct: 'C'
                }
            ]
        };

        const CATEGORIES = [
            { id: 1, name: "ภาค ก (ก.พ.)", count: "300 ข้อสอบ", progress: 70, color: "bg-blue-500", icon: "menu_book" },
            { id: 2, name: "ภาค ข (เฉพาะตำแหน่ง)", count: "450 ข้อสอบ", progress: 15, color: "bg-orange-500", icon: "engineering" },
            { id: 3, name: "ภาษาอังกฤษ", count: "300 ข้อสอบ", progress: 0, color: "bg-purple-500", icon: "language" },
            { id: 4, name: "กฎหมาย", count: "200 ข้อสอบ", progress: 45, color: "bg-red-500", icon: "gavel" },
            { id: 5, name: "ความรู้ทั่วไป", count: "150 ข้อสอบ", progress: 10, color: "bg-blue-400", icon: "newspaper" },
            { id: 6, name: "ท้องถิ่น", count: "320 ข้อสอบ", progress: 60, color: "bg-teal-500", icon: "apartment" },
        ];

        const ADMIN_STATS = [
            { title: "ผู้ใช้งานทั้งหมด", value: "...", icon: "group", color: "bg-blue-500" },
            { title: "ข้อสอบในระบบ", value: "1,250", icon: "library_books", color: "bg-green-500" },
            { title: "รอตรวจสอบ", value: "45", icon: "pending_actions", color: "bg-orange-500" },
            { title: "รายได้เดือนนี้", value: "฿125k", icon: "payments", color: "bg-purple-500" },
        ];

        // --- Helper Components ---
        function Icon({ name, className = "", style = {} }) {
            return <span className={`material-symbols-outlined ${className}`} style={style}>{name}</span>;
        }

        function LoadingSpinner() {
            return (
                <div className="flex justify-center items-center h-full w-full py-10">
                    <div className="spinner"></div>
                </div>
            );
        }

        // --- Main App ---
        function App() {
            const [currentScreen, setCurrentScreen] = useState('loading'); // loading, login, home, etc.
            const [user, setUser] = useState(null); // { uid, email, role, name }
            const [examState, setExamState] = useState({
                answers: {},
                currentQuestionIndex: 0,
                isFinished: false,
                score: 0,
                timeRemaining: MOCK_EXAM_DATA.timeLimit
            });

            // Auth State Listener
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
                    if (authUser) {
                        // Fetch user data from Firestore
                        try {
                            const userDoc = await db.collection('users').doc(authUser.uid).get();
                            if (userDoc.exists) {
                                setUser({ uid: authUser.uid, email: authUser.email, ...userDoc.data() });
                                
                                // Direct to correct home based on role
                                if (userDoc.data().role === 'admin') {
                                    setCurrentScreen('admin-home');
                                } else {
                                    setCurrentScreen('home');
                                }
                            } else {
                                // Fallback if no doc (shouldn't happen with proper register)
                                setUser({ uid: authUser.uid, email: authUser.email, role: 'user', name: 'User' });
                                setCurrentScreen('home');
                            }
                        } catch (error) {
                            console.error("Error fetching user data:", error);
                            // Fallback
                            setUser({ uid: authUser.uid, email: authUser.email, role: 'user', name: 'User' });
                            setCurrentScreen('home');
                        }
                    } else {
                        setUser(null);
                        setCurrentScreen('login');
                    }
                });
                return () => unsubscribe();
            }, []);

            const navigate = (screen) => {
                window.scrollTo(0, 0);
                setCurrentScreen(screen);
            };

            const handleLogout = async () => {
                await auth.signOut();
                navigate('login');
            };

            const startExam = () => {
                setExamState({
                    answers: {},
                    currentQuestionIndex: 0,
                    isFinished: false,
                    score: 0,
                    timeRemaining: MOCK_EXAM_DATA.timeLimit
                });
                navigate('exam');
            };

            const handleAnswer = (questionId, optionId) => {
                setExamState(prev => ({
                    ...prev,
                    answers: { ...prev.answers, [questionId]: optionId }
                }));
            };

            const submitExam = async () => {
                let correctCount = 0;
                MOCK_EXAM_DATA.questions.forEach(q => {
                    if (examState.answers[q.id] === q.correct) {
                        correctCount++;
                    }
                });
                const scorePercentage = Math.round((correctCount / MOCK_EXAM_DATA.questions.length) * 100);
                
                // Save Result to Firestore
                if (user) {
                    try {
                        await db.collection('exam_results').add({
                            userId: user.uid,
                            examTitle: MOCK_EXAM_DATA.title,
                            score: scorePercentage,
                            date: new Date(),
                            status: scorePercentage >= 60 ? 'pass' : 'fail'
                        });
                        console.log("Exam saved");
                    } catch (e) {
                        console.error("Error saving exam:", e);
                    }
                }

                setExamState(prev => ({
                    ...prev,
                    isFinished: true,
                    score: scorePercentage
                }));
                navigate('result');
            };

            // Timer Logic
            useEffect(() => {
                let interval;
                if (currentScreen === 'exam' && !examState.isFinished && examState.timeRemaining > 0) {
                    interval = setInterval(() => {
                        setExamState(prev => {
                            if (prev.timeRemaining <= 1) {
                                clearInterval(interval);
                                submitExam();
                                return { ...prev, timeRemaining: 0 };
                            }
                            return { ...prev, timeRemaining: prev.timeRemaining - 1 };
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [currentScreen, examState.isFinished]);

            // Rendering Logic
            if (currentScreen === 'loading') {
                return <div className="min-h-screen flex items-center justify-center bg-white"><div className="spinner"></div></div>;
            }

            return (
                <div id="app-container">
                    {/* User Screens */}
                    {currentScreen === 'login' && <LoginScreen onNavigate={navigate} />}
                    {currentScreen === 'register' && <RegisterScreen onNavigate={navigate} />}
                    
                    {currentScreen === 'home' && <HomeScreen user={user} onNavigate={navigate} onStartExam={startExam} />}
                    {currentScreen === 'category' && <CategoryScreen onNavigate={navigate} />}
                    {currentScreen === 'history' && <HistoryScreen user={user} onNavigate={navigate} />}
                    {currentScreen === 'profile' && <ProfileScreen user={user} onNavigate={navigate} onLogout={handleLogout} />}
                    
                    {/* Exam Screens */}
                    {currentScreen === 'exam' && (
                        <ExamScreen 
                            examData={MOCK_EXAM_DATA} 
                            examState={examState} 
                            onAnswer={handleAnswer} 
                            onSubmit={submitExam}
                            onNavigate={navigate}
                            setExamState={setExamState}
                        />
                    )}
                    {currentScreen === 'result' && (
                        <ResultScreen 
                            examState={examState} 
                            totalQuestions={MOCK_EXAM_DATA.questions.length}
                            onNavigate={navigate}
                            onRetry={startExam}
                        />
                    )}

                    {/* Admin Screens (Protected) */}
                    {currentScreen === 'admin-home' && user?.role === 'admin' && <AdminHomeScreen user={user} onNavigate={navigate} onLogout={handleLogout} />}
                    {currentScreen === 'admin-exams' && user?.role === 'admin' && <AdminExamScreen onNavigate={navigate} />}
                    {currentScreen === 'admin-users' && user?.role === 'admin' && <AdminUserScreen onNavigate={navigate} />}
                </div>
            );
        }

        // --- Screens ---

        function LoginScreen({ onNavigate }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    // onAuthStateChanged in App will handle navigation
                } catch (err) {
                    setError('อีเมลหรือรหัสผ่านไม่ถูกต้อง');
                    setLoading(false);
                }
            };
            
            return (
                <div className="flex flex-col items-center justify-center min-h-screen px-6 relative overflow-hidden bg-white">
                    <div className="absolute top-[-10%] right-[-5%] w-72 h-72 bg-primary/10 rounded-full blur-3xl"></div>
                    <div className="absolute bottom-[-10%] left-[-5%] w-72 h-72 bg-blue-400/10 rounded-full blur-3xl"></div>
                    
                    <div className="w-full max-w-sm z-10">
                        <div className="flex flex-col items-center mb-10">
                            <div className="w-16 h-16 bg-primary rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20 mb-4 transform -rotate-3 hover:rotate-0 transition-transform duration-300">
                                <Icon name="history_edu" className="text-white text-4xl" />
                            </div>
                            <h1 className="text-2xl font-bold text-[#111418]">เข้าสู่ระบบ</h1>
                            <p className="text-slate-500 text-sm mt-2">เตรียมตัวสอบข้าราชการไปกับเรา</p>
                        </div>

                        <form className="flex flex-col gap-5" onSubmit={handleLogin}>
                            {error && <div className="bg-red-50 text-red-500 text-sm p-3 rounded-xl text-center">{error}</div>}
                            
                            <div className="space-y-1.5">
                                <label className="text-sm font-medium text-slate-700 ml-1">อีเมล</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                                        <Icon name="mail" className="text-slate-400 group-focus-within:text-primary transition-colors" />
                                    </div>
                                    <input 
                                        type="email"
                                        required
                                        className="block w-full rounded-2xl border-0 py-3.5 pl-12 text-[#111418] shadow-sm ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary bg-white" 
                                        placeholder="user@example.com" 
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                    />
                                </div>
                            </div>
                            
                            <div className="space-y-1.5">
                                <label className="text-sm font-medium text-slate-700 ml-1">รหัสผ่าน</label>
                                <div className="relative group">
                                    <div className="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                                        <Icon name="lock" className="text-slate-400 group-focus-within:text-primary transition-colors" />
                                    </div>
                                    <input 
                                        type="password"
                                        required
                                        className="block w-full rounded-2xl border-0 py-3.5 pl-12 pr-12 text-[#111418] shadow-sm ring-1 ring-inset ring-slate-200 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-primary bg-white" 
                                        placeholder="••••••••" 
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                    />
                                </div>
                            </div>

                            <button disabled={loading} type="submit" className="w-full rounded-2xl bg-primary px-3.5 py-3.5 text-base font-bold text-white shadow-lg shadow-blue-500/30 hover:bg-blue-600 active:scale-[0.98] transition-all mt-2 disabled:opacity-70 flex justify-center">
                                {loading ? <div className="spinner border-white border-b-transparent h-6 w-6"></div> : 'เข้าสู่ระบบ'}
                            </button>
                        </form>

                         <div className="mt-8 flex flex-col items-center gap-6">
                            <p className="text-center text-sm text-slate-500">
                                ยังไม่มีบัญชีสมาชิก?
                                <button onClick={() => onNavigate('register')} className="font-bold text-primary hover:text-blue-600 transition-colors ml-1">สมัครสมาชิก</button>
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        function RegisterScreen({ onNavigate }) {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isAdmin, setIsAdmin] = useState(false); // Checkbox mock for demo
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    // 1. Create User in Auth
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    // 2. Save additional info in Firestore
                    await db.collection('users').doc(user.uid).set({
                        name: name,
                        email: email,
                        role: isAdmin ? 'admin' : 'user', // In real app, secure this
                        createdAt: new Date()
                    });

                    // Navigation handled by onAuthStateChanged
                } catch (err) {
                    console.error(err);
                    setError(err.message || 'เกิดข้อผิดพลาดในการสมัครสมาชิก');
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-white flex flex-col">
                    <div className="flex items-center p-4">
                        <button onClick={() => onNavigate('login')} className="w-10 h-10 rounded-full hover:bg-slate-100 flex items-center justify-center transition-colors">
                            <Icon name="arrow_back" className="text-slate-800" />
                        </button>
                    </div>
                    <div className="flex flex-col items-center px-6 pt-2 pb-6">
                        <div className="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mb-4 text-primary">
                            <Icon name="person_add" className="text-4xl" />
                        </div>
                        <h1 className="text-2xl font-bold text-[#111418]">สร้างบัญชีผู้ใช้</h1>
                        <p className="text-slate-500 mt-2 text-center">เริ่มต้นเตรียมสอบข้าราชการไปกับเรา</p>
                    </div>
                    <form className="px-6 pb-6 flex flex-col gap-4 max-w-md mx-auto w-full" onSubmit={handleRegister}>
                        {error && <div className="bg-red-50 text-red-500 text-sm p-3 rounded-xl text-center">{error}</div>}
                        
                        <div className="space-y-1">
                            <label className="text-base font-medium text-[#111418]">ชื่อ-นามสกุล</label>
                            <input required className="w-full h-12 rounded-xl border border-slate-200 px-4 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none" 
                                placeholder="สมชาย ใจดี" value={name} onChange={(e) => setName(e.target.value)} />
                        </div>
                        <div className="space-y-1">
                            <label className="text-base font-medium text-[#111418]">อีเมล</label>
                            <input required type="email" className="w-full h-12 rounded-xl border border-slate-200 px-4 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none" 
                                placeholder="example@email.com" value={email} onChange={(e) => setEmail(e.target.value)} />
                        </div>
                        <div className="space-y-1">
                            <label className="text-base font-medium text-[#111418]">รหัสผ่าน</label>
                            <input required type="password" className="w-full h-12 rounded-xl border border-slate-200 px-4 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none" 
                                placeholder="อย่างน้อย 6 ตัวอักษร" value={password} onChange={(e) => setPassword(e.target.value)} />
                        </div>

                        {/* Secret Admin Checkbox for Demo */}
                        <div className="flex items-center gap-2">
                            <input type="checkbox" id="adminCheck" checked={isAdmin} onChange={(e) => setIsAdmin(e.target.checked)} />
                            <label htmlFor="adminCheck" className="text-sm text-slate-500">สมัครในฐานะผู้ดูแลระบบ (Demo Only)</label>
                        </div>
                        
                        <button disabled={loading} type="submit" className="w-full h-12 bg-primary text-white rounded-xl font-bold text-base shadow-lg shadow-blue-500/20 hover:bg-blue-600 active:scale-[0.98] transition-all flex justify-center items-center">
                            {loading ? <div className="spinner border-white border-b-transparent h-6 w-6"></div> : 'สมัครสมาชิก'}
                        </button>
                    </form>
                </div>
            );
        }

        function HomeScreen({ user, onNavigate, onStartExam }) {
            return (
                <div className="pb-24 bg-[#f6f7f8] min-h-screen">
                    <header className="flex items-center justify-between bg-white p-4 sticky top-0 z-10 shadow-sm">
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => onNavigate('profile')}>
                             <div className="w-10 h-10 rounded-full bg-slate-200 border-2 border-primary/20 flex items-center justify-center overflow-hidden">
                                <Icon name="person" className="text-slate-500" />
                            </div>
                            <div className="flex flex-col">
                                <span className="text-xs text-slate-500 font-medium">ยินดีต้อนรับกลับ</span>
                                <h2 className="text-lg font-bold leading-tight">สวัสดี, {user?.name || 'ผู้เยี่ยมชม'}!</h2>
                            </div>
                        </div>
                        <button className="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-50 relative transition-colors">
                            <Icon name="notifications" className="text-[#111418]" />
                        </button>
                    </header>

                    <main className="flex flex-col gap-6 px-4 pt-6 max-w-2xl mx-auto w-full">
                        {/* Progress Card */}
                        <div className="bg-primary rounded-2xl p-5 shadow-lg shadow-blue-500/20 text-white relative overflow-hidden">
                             <div className="absolute -right-6 -top-6 w-32 h-32 rounded-full bg-white/10 blur-2xl"></div>
                             <div className="relative z-10">
                                <h3 className="text-lg font-bold mb-1">ความคืบหน้า</h3>
                                <div className="flex items-end gap-4 mb-2">
                                    <span className="text-4xl font-bold">65%</span>
                                    <span className="text-sm text-blue-100 mb-1.5">ของหลักสูตร</span>
                                </div>
                                <div className="w-full bg-black/20 rounded-full h-2.5 mb-4 overflow-hidden">
                                    <div className="bg-white h-2.5 rounded-full" style={{ width: '65%' }}></div>
                                </div>
                             </div>
                        </div>

                        {/* Quick Actions */}
                        <div className="grid grid-cols-4 gap-4">
                             {[
                                { label: 'เริ่มสอบ', icon: 'play_circle', color: 'bg-blue-50 text-primary', action: onStartExam },
                                { label: 'ทบทวน', icon: 'menu_book', color: 'bg-orange-50 text-orange-500', action: () => onNavigate('category') },
                                { label: 'ควิซ', icon: 'quiz', color: 'bg-purple-50 text-purple-500', action: () => {} },
                                { label: 'แผนการ', icon: 'map', color: 'bg-green-50 text-green-600', action: () => {} }
                            ].map((item, idx) => (
                                <button key={idx} onClick={item.action} className="flex flex-col items-center gap-2 group active:scale-95 transition-transform">
                                    <div className={`w-14 h-14 md:w-16 md:h-16 rounded-2xl flex items-center justify-center ${item.color}`}>
                                        <Icon name={item.icon} className="text-3xl" />
                                    </div>
                                    <span className="text-xs font-medium text-slate-700">{item.label}</span>
                                </button>
                            ))}
                        </div>
                    </main>

                    <BottomNav active="home" onNavigate={onNavigate} />
                </div>
            );
        }

        function HistoryScreen({ user, onNavigate }) {
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!user) return;
                const fetchHistory = async () => {
                    try {
                        const snapshot = await db.collection('exam_results')
                            .where('userId', '==', user.uid)
                            .orderBy('date', 'desc')
                            .get();
                        
                        const data = snapshot.docs.map(doc => {
                            const d = doc.data();
                            return {
                                id: doc.id,
                                ...d,
                                // Format date safely
                                dateString: d.date && d.date.toDate ? d.date.toDate().toLocaleDateString('th-TH') : 'N/A'
                            };
                        });
                        setHistory(data);
                    } catch (error) {
                        console.error("Error fetching history:", error);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchHistory();
            }, [user]);

            return (
                <div className="min-h-screen bg-[#f6f7f8] pb-24">
                    <div className="sticky top-0 z-20 flex items-center justify-between bg-white p-4 border-b border-slate-100 shadow-sm">
                        <button onClick={() => onNavigate('home')}><Icon name="arrow_back" className="text-[#111418]" /></button>
                        <h1 className="text-lg font-bold">ประวัติการสอบ</h1>
                        <button><Icon name="filter_list" className="text-primary" /></button>
                    </div>

                    {loading ? <LoadingSpinner /> : (
                        <div className="px-4 py-4 flex flex-col gap-3">
                            {history.length === 0 ? (
                                <div className="text-center text-slate-500 mt-10">ยังไม่มีประวัติการสอบ</div>
                            ) : (
                                history.map((item) => (
                                    <div key={item.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col gap-3">
                                        <div className="flex justify-between items-start">
                                            <div className="flex gap-3">
                                                <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${item.status === 'pass' ? 'bg-blue-50 text-primary' : 'bg-red-50 text-red-500'}`}>
                                                    <Icon name="description" />
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-[#111418] text-sm">{item.examTitle}</h4>
                                                    <p className="text-xs text-slate-500">วันที่ {item.dateString}</p>
                                                </div>
                                            </div>
                                            <span className={`px-2 py-1 rounded-lg text-xs font-bold ${item.status === 'pass' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                {item.score}%
                                            </span>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                    <BottomNav active="history" onNavigate={onNavigate} />
                </div>
            );
        }

        function ProfileScreen({ user, onNavigate, onLogout }) {
            return (
                <div className="min-h-screen bg-[#f6f7f8] pb-24">
                    <div className="bg-white pb-4">
                        <div className="flex items-center justify-between p-4">
                            <button onClick={() => onNavigate('home')}><Icon name="arrow_back" className="text-[#111418]" /></button>
                            <h2 className="text-lg font-bold">โปรไฟล์</h2>
                            <div className="w-6"></div>
                        </div>
                        <div className="flex flex-col items-center gap-3">
                            <div className="w-24 h-24 rounded-full bg-slate-200 relative border-4 border-white shadow-md flex items-center justify-center">
                                <span className="text-4xl text-slate-400 font-bold">{user?.name ? user.name.charAt(0) : 'U'}</span>
                            </div>
                            <div className="text-center">
                                <h3 className="text-xl font-bold text-[#111418]">{user?.name || 'User'}</h3>
                                <p className="text-sm text-slate-500">{user?.email}</p>
                            </div>
                        </div>
                    </div>

                    <div className="mt-4 px-4">
                        <button onClick={onLogout} className="w-full py-3 text-red-600 font-bold bg-white rounded-xl shadow-sm border border-slate-200 hover:bg-red-50 transition-colors">
                            ออกจากระบบ
                        </button>
                    </div>

                    <BottomNav active="profile" onNavigate={onNavigate} />
                </div>
            );
        }

        // --- Admin Screens ---

        function AdminHomeScreen({ user, onNavigate, onLogout }) {
            const [stats, setStats] = useState({ users: 0, exams: 0 });

            useEffect(() => {
                // Mock fetching stats or real fetch
                // For demo, we just rely on hardcoded or simple logic
                // Real implementation would be `db.collection('users').get()...` but that's expensive for client
            }, []);

            return (
                <div className="pb-24 bg-[#f6f7f8] min-h-screen">
                    <header className="flex items-center justify-between bg-white p-4 sticky top-0 z-10 shadow-sm border-b border-purple-100">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-admin-primary text-white flex items-center justify-center">
                                <Icon name="admin_panel_settings" />
                            </div>
                            <div className="flex flex-col">
                                <span className="text-xs text-slate-500 font-medium">Administrator</span>
                                <h2 className="text-lg font-bold leading-tight text-admin-primary">{user?.name}</h2>
                            </div>
                        </div>
                        <button onClick={onLogout} className="p-2 text-slate-400 hover:text-red-500">
                            <Icon name="logout" />
                        </button>
                    </header>

                    <main className="flex flex-col gap-6 px-4 pt-6 max-w-4xl mx-auto w-full">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {ADMIN_STATS.map((stat, idx) => (
                                <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col gap-2">
                                    <div className={`w-10 h-10 rounded-lg ${stat.color} bg-opacity-10 flex items-center justify-center`}>
                                        <Icon name={stat.icon} className={`text-${stat.color.split('-')[1]}-600`} />
                                    </div>
                                    <div>
                                        <p className="text-slate-500 text-xs">{stat.title}</p>
                                        <p className="text-xl font-bold text-[#111418]">{stat.value}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>
                    
                    <AdminBottomNav active="admin-home" onNavigate={onNavigate} />
                </div>
            );
        }

        function AdminExamScreen({ onNavigate }) {
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const newQuestions = [];
                    let parseErrors = 0;

                    for (let line of lines) {
                        line = line.trim();
                        if (!line) continue;

                        // Check if line matches the exact format: "q","c1","c2","c3","c4","ans","exp"
                        // Assuming simple CSV where quotes strictly wrap fields and fields don't contain quotes or newlines
                        // Regex: ^"(.+)","(.+)","(.+)","(.+)","(.+)","(.+)","(.+)"$
                        // Note: This regex is simple and works for the specific requirement. 
                        // It does NOT handle escaped quotes inside the text.
                        const matches = line.match(/^"(.+)","(.+)","(.+)","(.+)","(.+)","(.+)","(.+)"$/);
                        
                        if (matches && matches.length === 8) { 
                            newQuestions.push({
                                question: matches[1],
                                options: [
                                    { id: 'A', text: matches[2] },
                                    { id: 'B', text: matches[3] },
                                    { id: 'C', text: matches[4] },
                                    { id: 'D', text: matches[5] }
                                ],
                                correct: matches[6], 
                                explanation: matches[7],
                                id: Date.now() + Math.random() // Temp ID
                            });
                        } else {
                            parseErrors++;
                        }
                    }

                    if (newQuestions.length > 0) {
                        alert(`อ่านไฟล์สำเร็จ! พบข้อสอบ ${newQuestions.length} ข้อ${parseErrors > 0 ? ` (ข้าม ${parseErrors} บรรทัดที่ผิดรูปแบบ)` : ''}`);
                        
                        console.log("Parsed Questions:", newQuestions);
                        // Save to Firestore (Mocked for demo but logic is valid)
                        try {
                            const batch = db.batch();
                             newQuestions.forEach(q => {
                                const ref = db.collection('questions_bank').doc(); // Store in a collection
                                batch.set(ref, q);
                             });
                             // await batch.commit(); 
                             console.log("Batch commit logic ready.");
                        } catch(err) {
                            console.error("Error saving:", err);
                        }

                    } else {
                        alert("ไม่พบข้อมูลที่ถูกต้อง กรุณาตรวจสอบรูปแบบไฟล์ CSV:\n\"คำถาม\",\"ก\",\"ข\",\"ค\",\"ง\",\"คำตอบ\",\"คำอธิบาย\"");
                    }
                };
                reader.readAsText(file);
            };

            return (
                 <div className="pb-24 bg-[#f6f7f8] min-h-screen">
                    <div className="sticky top-0 z-20 flex items-center justify-between bg-white p-4 border-b border-slate-100 shadow-sm">
                        <h2 className="text-lg font-bold text-[#111418]">จัดการข้อสอบ</h2>
                        <div className="flex gap-2">
                             <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" id="csv-upload" />
                            <label htmlFor="csv-upload" className="bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 cursor-pointer hover:bg-green-700 transition-colors">
                                <Icon name="upload_file" className="text-base" /> นำเข้า CSV
                            </label>
                            <button className="bg-admin-primary text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1">
                                <Icon name="add" className="text-base" /> เพิ่ม
                            </button>
                        </div>
                    </div>

                    <div className="p-4 max-w-4xl mx-auto w-full">
                        <div className="flex flex-col gap-3">
                            <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg text-sm text-blue-800 mb-2">
                                <p className="font-bold mb-1"><Icon name="info" className="text-sm align-middle" /> รูปแบบไฟล์ CSV ที่รองรับ:</p>
                                <code className="bg-white px-2 py-1 rounded border border-blue-100 block overflow-x-auto">
                                    "โจทย์","ก","ข","ค","ง","เฉลย","คำอธิบาย"
                                </code>
                            </div>

                            {[1, 2, 3, 4].map(i => (
                                <div key={i} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                    <div className="flex gap-3">
                                        <div className="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center text-blue-600 shrink-0">
                                            <Icon name="description" />
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-[#111418]">แนวข้อสอบชุดที่ {i}</h4>
                                            <p className="text-xs text-slate-500">กฎหมาย • 50 ข้อ • 60 นาที</p>
                                            <div className="flex gap-2 mt-1">
                                                <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full">เผยแพร่แล้ว</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 self-end sm:self-center">
                                        <button className="p-2 text-slate-400 hover:text-admin-primary bg-slate-50 rounded-lg"><Icon name="edit" /></button>
                                        <button className="p-2 text-slate-400 hover:text-red-500 bg-slate-50 rounded-lg"><Icon name="delete" /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <AdminBottomNav active="admin-exams" onNavigate={onNavigate} />
                </div>
            );
        }

        function AdminUserScreen({ onNavigate }) { return <div className="p-4"><button onClick={()=>onNavigate('admin-home')}>Back</button> Admin Users</div>; }

        function CategoryScreen({ onNavigate }) { return <div className="p-4"><button onClick={()=>onNavigate('home')}>Back</button> Category Screen</div>; }

        function ExamScreen({ examData, examState, setExamState, onAnswer, onSubmit, onNavigate }) {
            const currentQ = examData.questions[examState.currentQuestionIndex];
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };
            return (
                <div className="flex flex-col h-screen bg-white">
                    <header className="flex-none flex items-center justify-between p-4 border-b border-slate-100">
                        <button onClick={() => onNavigate('home')}><Icon name="close" className="text-slate-800" /></button>
                        <h2 className="font-bold text-lg text-[#111418]">การสอบ</h2>
                        <button><Icon name="grid_view" className="text-slate-500" /></button>
                    </header>
                    <div className="flex-none px-4 py-3 bg-white shadow-sm z-10">
                        <div className="flex justify-between items-center mb-2 max-w-2xl mx-auto w-full">
                            <div className="flex items-center gap-2 text-primary">
                                <Icon name="timer" className="text-xl" />
                                <span className="text-lg font-bold tabular-nums">{formatTime(examState.timeRemaining)}</span>
                            </div>
                        </div>
                         <div className="max-w-2xl mx-auto w-full">
                            <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                <div className="bg-primary h-full transition-all duration-300" style={{ width: `${((examState.currentQuestionIndex + 1) / examData.questions.length) * 100}%` }}></div>
                            </div>
                        </div>
                    </div>
                    <main className="flex-1 overflow-y-auto p-4 pb-20">
                        <div className="flex flex-col gap-4 max-w-2xl mx-auto w-full">
                            <h2 className="text-xl font-bold text-[#111418] leading-snug">{currentQ.question}</h2>
                            <div className="flex flex-col gap-3">
                                {currentQ.options.map((opt) => {
                                    const isSelected = examState.answers[currentQ.id] === opt.id;
                                    return (
                                        <label key={opt.id} className={`flex items-center gap-4 p-4 rounded-xl border cursor-pointer transition-all ${isSelected ? 'border-primary bg-primary/5' : 'border-slate-200 hover:border-primary/50'}`}>
                                            <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center shrink-0 ${isSelected ? 'border-primary' : 'border-slate-300'}`}>
                                                {isSelected && <div className="w-2.5 h-2.5 rounded-full bg-primary" />}
                                            </div>
                                            <input type="radio" name={`q-${currentQ.id}`} className="hidden" onChange={() => onAnswer(currentQ.id, opt.id)} checked={isSelected} />
                                            <span className={`text-base font-medium ${isSelected ? 'text-primary' : 'text-[#111418]'}`}>{opt.text}</span>
                                        </label>
                                    );
                                })}
                            </div>
                        </div>
                    </main>
                    <footer className="flex-none p-4 border-t border-slate-100 bg-white pb-safe">
                        <div className="max-w-2xl mx-auto flex gap-4 w-full">
                             {examState.currentQuestionIndex === examData.questions.length - 1 ? (
                                <button onClick={onSubmit} className="flex-1 h-12 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 shadow-lg flex items-center justify-center gap-2">
                                    ส่งข้อสอบ <Icon name="check_circle" />
                                </button>
                            ) : (
                                <button onClick={() => setExamState(p => ({ ...p, currentQuestionIndex: Math.min(examData.questions.length - 1, p.currentQuestionIndex + 1) }))} className="flex-1 h-12 rounded-xl bg-primary text-white font-bold hover:bg-blue-600 shadow-lg flex items-center justify-center gap-2">
                                    ถัดไป <Icon name="chevron_right" />
                                </button>
                            )}
                        </div>
                    </footer>
                </div>
            );
        }

        function ResultScreen({ examState, onNavigate }) {
            return (
                <div className="flex flex-col min-h-screen bg-white">
                     <div className="flex items-center p-4 border-b border-slate-100">
                        <button onClick={() => onNavigate('home')} className="mr-auto"><Icon name="close" className="text-[#111418]" /></button>
                        <h2 className="text-lg font-bold flex-1 text-center pr-6">ผลการสอบ</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 flex flex-col items-center">
                         <div className="relative w-48 h-48 flex items-center justify-center mb-6">
                            <div className="flex flex-col items-center">
                                <span className="text-slate-500 text-sm font-medium">คะแนนรวม</span>
                                <span className="text-5xl font-bold text-[#111418]">{examState.score}</span>
                            </div>
                        </div>
                        <h2 className="text-2xl font-bold text-[#111418] mb-2">{examState.score >= 60 ? 'ยินดีด้วย!' : 'พยายามใหม่นะ'}</h2>
                        <button onClick={() => onNavigate('home')} className="w-full max-w-xs h-12 flex items-center justify-center rounded-xl bg-primary text-white font-bold hover:bg-blue-600">เสร็จสิ้น</button>
                    </div>
                </div>
            )
        }

        function BottomNav({ active, onNavigate }) {
            const navItems = [
                { id: 'home', icon: 'home', label: 'หน้าหลัก' },
                { id: 'category', icon: 'menu_book', label: 'วิชาสอบ' },
                { id: 'history', icon: 'bar_chart', label: 'ประวัติ' },
                { id: 'profile', icon: 'person', label: 'โปรไฟล์' }
            ];
            return (
                <div className="fixed bottom-0 w-full bg-white border-t border-slate-100 px-6 py-2 flex justify-between items-center z-50 pb-safe max-w-[inherit] left-auto right-auto">
                    {navItems.map((item) => (
                        <button key={item.id} onClick={() => onNavigate(item.id)} className={`flex flex-col items-center gap-1 p-2 transition-colors ${active === item.id ? 'text-primary' : 'text-slate-400'}`}>
                            <Icon name={item.icon} className={active === item.id ? 'fill-current' : ''} style={{ fontVariationSettings: active === item.id ? "'FILL' 1" : "'FILL' 0" }} />
                            <span className="text-[10px] font-medium">{item.label}</span>
                        </button>
                    ))}
                </div>
            );
        }

        function AdminBottomNav({ active, onNavigate }) {
            const navItems = [
                { id: 'admin-home', icon: 'dashboard', label: 'ภาพรวม' },
                { id: 'admin-exams', icon: 'library_books', label: 'ข้อสอบ' },
                { id: 'admin-users', icon: 'group', label: 'ผู้ใช้' },
                { id: 'home', icon: 'visibility', label: 'ดูหน้าเว็บ' }
            ];
            return (
                <div className="fixed bottom-0 w-full bg-white border-t border-purple-100 px-6 py-2 flex justify-between items-center z-50 pb-safe max-w-[inherit] left-auto right-auto">
                    {navItems.map((item) => (
                        <button key={item.id} onClick={() => onNavigate(item.id)} className={`flex flex-col items-center gap-1 p-2 transition-colors ${active === item.id ? 'text-admin-primary' : 'text-slate-400'}`}>
                            <Icon name={item.icon} />
                            <span className="text-[10px] font-medium">{item.label}</span>
                        </button>
                    ))}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
