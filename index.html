<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TheONE สอบราชการ - Admin System</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material Symbols (Icons) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "admin-primary": "#7c3aed",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "Noto Sans Thai", "sans-serif"],
                        "body": ["Public Sans", "Noto Sans Thai", "sans-serif"],
                    },
                },
            },
        }
    </script>

    <!-- React & ReactDOM & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK (Using Compat version for simplicity in this single-file setup) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Public Sans', 'Noto Sans Thai', sans-serif; background-color: #f3f4f6; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #app-container {
            max-width: 100%;
            margin: 0 auto;
            min-height: 100vh;
            background-color: white;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        
        @media (min-width: 768px) {
            #app-container { max-width: 768px; }
        }
        
        @media (min-width: 1024px) {
            body { padding: 0; display: flex; justify-content: center; }
            #app-container { max-width: 600px; min-height: 100vh; border-left: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; }
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #137fec;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">
    <div id="root" class="w-full"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Firebase Config (กรุณาตรวจสอบความถูกต้องของ API Key ใน Console ของคุณ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDF6XI3Rs4CAdA83QQQ2aQ1J-prKT7mqlg",
            authDomain: "application-01-986a7.firebaseapp.com",
            projectId: "application-01-986a7",
            storageBucket: "application-01-986a7.firebasestorage.app",
            messagingSenderId: "206440554854",
            appId: "1:206440554854:web:2d804d1e35c824fadca8a7"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Utility Components ---
        function Icon({ name, className = "" }) {
            return <span className={`material-symbols-outlined ${className}`}>{name}</span>;
        }

        // --- Main App ---
        function App() {
            const [currentScreen, setCurrentScreen] = useState('loading'); 
            const [user, setUser] = useState(null);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
                    if (authUser) {
                        try {
                            // ดึงข้อมูล User จาก Firestore เพื่อเช็ค Role
                            const userDoc = await db.collection('users').doc(authUser.uid).get();
                            
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                const fullUserData = { uid: authUser.uid, email: authUser.email, ...userData };
                                setUser(fullUserData);

                                // Logic การเปลี่ยนหน้าตามสิทธิ์
                                if (userData.status === 'pending') {
                                    setCurrentScreen('pending-approval');
                                } else if (userData.role === 'admin') {
                                    setCurrentScreen('admin-home');
                                } else {
                                    setCurrentScreen('home');
                                }
                            } else {
                                // กรณีไม่มีข้อมูลใน Firestore (อาจจะสมัครผ่าน Console โดยตรง)
                                console.error("No user data found in Firestore collection 'users'");
                                setAuthError("ไม่พบข้อมูลสิทธิ์การใช้งานในระบบ โปรดติดต่อแอดมิน");
                                await auth.signOut();
                                setCurrentScreen('login');
                            }
                        } catch (error) {
                            console.error("Fetch User Error:", error);
                            setAuthError("เกิดข้อผิดพลาดในการโหลดข้อมูลโปรไฟล์");
                            setCurrentScreen('login');
                        }
                    } else {
                        setUser(null);
                        setCurrentScreen('login');
                    }
                });
                return () => unsubscribe();
            }, []);

            const handleLogout = async () => {
                await auth.signOut();
                setCurrentScreen('login');
            };

            if (currentScreen === 'loading') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-white">
                        <div className="flex flex-col items-center gap-4">
                            <div className="spinner border-primary border-t-transparent w-10 h-10"></div>
                            <p className="text-slate-500 animate-pulse font-medium">กำลังโหลดข้อมูล...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div id="app-container">
                    {currentScreen === 'login' && (
                        <LoginScreen 
                            errorMsg={authError} 
                            clearError={() => setAuthError(null)} 
                            onNavigate={(s) => setCurrentScreen(s)} 
                        />
                    )}
                    {currentScreen === 'register' && (
                        <RegisterScreen onNavigate={(s) => setCurrentScreen(s)} />
                    )}
                    {currentScreen === 'pending-approval' && (
                        <PendingApprovalScreen onLogout={handleLogout} />
                    )}
                    
                    {/* Screens สำหรับ User ทั่วไป */}
                    {currentScreen === 'home' && (
                        <div className="p-10 text-center">
                            <h1 className="text-2xl font-bold">หน้าแรก (User)</h1>
                            <p className="mt-4">คุณกำลังเข้าใช้งานในฐานะผู้ใช้ทั่วไป</p>
                            <button onClick={handleLogout} className="mt-10 text-red-500 font-bold underline">ออกจากระบบ</button>
                        </div>
                    )}

                    {/* Screens สำหรับ Admin */}
                    {currentScreen === 'admin-home' && (
                        <div className="p-10 text-center bg-purple-50 min-h-screen">
                            <div className="w-20 h-20 bg-purple-600 text-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg">
                                <Icon name="admin_panel_settings" className="text-4xl" />
                            </div>
                            <h1 className="text-2xl font-bold text-purple-900">แผงควบคุมผู้ดูแลระบบ</h1>
                            <p className="mt-2 text-purple-700 italic">ยินดีต้อนรับคุณ {user?.name}</p>
                            
                            <div className="grid grid-cols-1 gap-4 mt-10 text-left">
                                <div className="bg-white p-4 rounded-xl border border-purple-200 shadow-sm flex items-center gap-4">
                                    <Icon name="group" className="text-purple-500 text-3xl" />
                                    <div>
                                        <h3 className="font-bold">จัดการผู้ใช้งาน</h3>
                                        <p className="text-xs text-slate-500">อนุมัติหรือลบผู้ใช้ในระบบ</p>
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded-xl border border-purple-200 shadow-sm flex items-center gap-4">
                                    <Icon name="history_edu" className="text-purple-500 text-3xl" />
                                    <div>
                                        <h3 className="font-bold">จัดการข้อสอบ</h3>
                                        <p className="text-xs text-slate-500">เพิ่ม ลบ หรือแก้ไขชุดข้อสอบ</p>
                                    </div>
                                </div>
                            </div>

                            <button onClick={handleLogout} className="mt-12 w-full py-3 bg-red-500 text-white rounded-xl font-bold shadow-md hover:bg-red-600 transition-colors">
                                ออกจากระบบ Admin
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // --- Login Screen ---
        function LoginScreen({ errorMsg, clearError, onNavigate }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [localError, setLocalError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLocalError('');
                clearError();
                setLoading(true);
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    console.error("Login Error:", err.code);
                    if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
                        setLocalError('อีเมลหรือรหัสผ่านไม่ถูกต้อง');
                    } else if (err.code === 'auth/invalid-email') {
                        setLocalError('รูปแบบอีเมลไม่ถูกต้อง');
                    } else {
                        setLocalError('เกิดข้อผิดพลาดในการเข้าสู่ระบบ: ' + err.message);
                    }
                    setLoading(false);
                }
            };
            
            return (
                <div className="flex flex-col items-center justify-center min-h-screen px-6 bg-white">
                    <div className="w-full max-w-sm">
                        <div className="flex flex-col items-center mb-10">
                            <div className="w-24 h-24 rounded-full overflow-hidden shadow-xl mb-6 border-4 border-white">
                                <img src="https://img2.pic.in.th/channels4_profileb88383d3623b24ab.jpg" alt="Logo" className="w-full h-full object-cover" />
                            </div>
                            <h1 className="text-2xl font-bold text-[#111418]">เข้าสู่ระบบ Admin</h1>
                            <p className="text-slate-500 text-sm mt-2 text-center">หากต้องการสิทธิ์แอดมินอัตโนมัติ<br/>โปรดใช้เมลที่ขึ้นต้นด้วย "admin"</p>
                        </div>

                        <form className="flex flex-col gap-5" onSubmit={handleLogin}>
                            {(localError || errorMsg) && (
                                <div className="bg-red-50 text-red-500 text-sm p-3 rounded-xl text-center flex items-center justify-center gap-2 border border-red-100">
                                    <Icon name="error" className="text-lg" />
                                    {localError || errorMsg}
                                </div>
                            )}
                            
                            <div className="space-y-1.5">
                                <label className="text-sm font-medium text-slate-700 ml-1">อีเมล</label>
                                <input 
                                    type="email" 
                                    required 
                                    className="block w-full rounded-2xl border-0 py-3.5 px-4 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary outline-none" 
                                    placeholder="admin@example.com" 
                                    value={email} 
                                    onChange={(e) => setEmail(e.target.value)} 
                                />
                            </div>

                            <div className="space-y-1.5">
                                <label className="text-sm font-medium text-slate-700 ml-1">รหัสผ่าน</label>
                                <input 
                                    type="password" 
                                    required 
                                    className="block w-full rounded-2xl border-0 py-3.5 px-4 ring-1 ring-slate-200 focus:ring-2 focus:ring-primary outline-none" 
                                    placeholder="••••••••" 
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)} 
                                />
                            </div>

                            <button disabled={loading} type="submit" className="w-full rounded-2xl bg-primary px-3.5 py-4 text-base font-bold text-white shadow-lg shadow-blue-500/30 hover:bg-blue-600 active:scale-[0.98] transition-all mt-2 disabled:opacity-70 flex justify-center items-center gap-2">
                                {loading ? <div className="spinner border-white border-t-transparent h-5 w-5"></div> : 'เข้าสู่ระบบ'}
                            </button>
                        </form>

                        <div className="mt-8 text-center">
                            <button onClick={() => onNavigate('register')} className="text-primary font-bold">ยังไม่มีบัญชี? สมัครใหม่ที่นี่</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Register Screen ---
        function RegisterScreen({ onNavigate }) {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleRegister = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    // กำหนดค่า Role อัตโนมัติ (Demo Logic)
                    // ถ้าอีเมลขึ้นต้นด้วย admin จะเป็นแอดมินทันที
                    const isAdminEmail = email.toLowerCase().trim().startsWith('admin');

                    await db.collection('users').doc(user.uid).set({
                        name: name,
                        email: email,
                        role: isAdminEmail ? 'admin' : 'user',
                        status: isAdminEmail ? 'active' : 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // ระบบจะเด้งไปที่ onAuthStateChanged เอง
                } catch (err) {
                    console.error("Register Error:", err);
                    setError(err.message);
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-white p-6">
                    <button onClick={() => onNavigate('login')} className="mb-6 flex items-center text-slate-600">
                        <Icon name="arrow_back" /> กลับ
                    </button>
                    <h1 className="text-2xl font-bold mb-2">สมัครสมาชิกใหม่</h1>
                    <p className="text-slate-500 mb-6 text-sm italic">หมายเหตุ: สมัครด้วยเมลที่ขึ้นต้นด้วย "admin" เพื่อรับสิทธิ์แอดมินทันที</p>
                    
                    <form className="flex flex-col gap-4" onSubmit={handleRegister}>
                        {error && <div className="bg-red-50 text-red-500 p-3 rounded-lg text-xs">{error}</div>}
                        <input required placeholder="ชื่อ-นามสกุล" className="w-full p-4 border rounded-xl" value={name} onChange={e => setName(e.target.value)} />
                        <input required type="email" placeholder="อีเมล (เช่น admin_test@mail.com)" className="w-full p-4 border rounded-xl" value={email} onChange={e => setEmail(e.target.value)} />
                        <input required type="password" placeholder="รหัสผ่าน" className="w-full p-4 border rounded-xl" value={password} onChange={e => setPassword(e.target.value)} />
                        <button disabled={loading} className="w-full py-4 bg-primary text-white rounded-xl font-bold mt-4 shadow-md">
                            {loading ? "กำลังสมัคร..." : "สมัครสมาชิก"}
                        </button>
                    </form>
                </div>
            );
        }

        // --- Pending Approval Screen ---
        function PendingApprovalScreen({ onLogout }) {
            return (
                <div className="min-h-screen bg-white flex flex-col items-center justify-center p-6 text-center">
                    <div className="w-24 h-24 bg-orange-50 rounded-full flex items-center justify-center mb-6 text-orange-500">
                        <Icon name="hourglass_empty" className="text-5xl" />
                    </div>
                    <h1 className="text-2xl font-bold text-[#111418] mb-2">รอการอนุมัติสิทธิ์</h1>
                    <p className="text-slate-500 mb-8 max-w-xs">
                        บัญชีของคุณยังไม่มีสิทธิ์เข้าถึงหน้าแอดมิน<br/>
                        โปรดติดต่อผู้ดูแลระบบหลักเพื่อปรับสถานะให้คุณ
                    </p>
                    <button onClick={onLogout} className="w-full max-w-xs h-12 rounded-xl border border-slate-200 text-[#111418] font-bold hover:bg-slate-50 transition-colors">
                        กลับสู่หน้าล็อกอิน
                    </button>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
